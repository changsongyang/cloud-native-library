<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>问题排查 | 云原生资料库</title>
    <link>https://lib.jimmysong.io/tsb/troubleshooting/</link>
      <atom:link href="https://lib.jimmysong.io/tsb/troubleshooting/index.xml" rel="self" type="application/rss+xml" />
    <description>问题排查</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><lastBuildDate>Wed, 09 Aug 2023 12:00:00 +0800</lastBuildDate>
    <image>
      <url>https://lib.jimmysong.io/media/sharing.png</url>
      <title>问题排查</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/</link>
    </image>
    
    <item>
      <title>基本故障排除</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/troubleshooting/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/troubleshooting/</guid>
      <description>&lt;p&gt;本文档介绍了在 TSB 中进行基本故障排除的一些可能方法，以便查找特定路由的错误配置问题或 &lt;code&gt;50x&lt;/code&gt; 错误的常见原因。&lt;/p&gt;
&lt;h2 id=&#34;系统架构&#34;&gt;系统架构&lt;/h2&gt;
&lt;p&gt;在本文档中，采用了以下具有 Tier1-Tier2 设置的系统架构：&lt;/p&gt;
&lt;p&gt;有两个不同的集群，&lt;code&gt;training-mp&lt;/code&gt; 包含管理平面和配置为 tier1 的控制平面，&lt;code&gt;training-cp&lt;/code&gt; 配置为 tier2，包含 &lt;code&gt;bookinfo&lt;/code&gt; 和 &lt;code&gt;httpbin&lt;/code&gt; 应用程序。&lt;/p&gt;
&lt;p&gt;















&lt;figure  &gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img src=&#34;../../assets/operations/troubleshooting-diagram.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;/figure&gt;
&lt;/p&gt;
&lt;h2 id=&#34;tier1-网关故障排除&#34;&gt;Tier1 网关故障排除&lt;/h2&gt;
&lt;p&gt;当检测到 &lt;code&gt;50x&lt;/code&gt; 错误时，重要的是要理解错误消息，因为它会指向不同的信息源。&lt;/p&gt;
&lt;p&gt;例如，假设你使用 &lt;code&gt;curl&lt;/code&gt; 发出了一个 HTTP 请求到由 TSB 控制的服务之一，并且观察到类似以下的错误：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Failed to connect to &amp;lt;hostname&amp;gt; port &amp;lt;port&amp;gt;: Connection refused
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这通常意味着没有配置监听器。这又意味着我们要么：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;缺少网关对象&lt;/li&gt;
&lt;li&gt;访问了错误的端口&lt;/li&gt;
&lt;li&gt;网关没有正确配置，或者&lt;/li&gt;
&lt;li&gt;Tier1 网关的 Pod 没有运行。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;要检查监听器是否存在，你可以使用 &lt;code&gt;istioctl&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl pc listener &amp;lt;ingressgateway&amp;gt;.&amp;lt;namespace&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果没有监听器，或者你想检查当前配置，你需要审查你的网关配置。要获取网关对象，使用 &lt;code&gt;kubectl&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get gateway
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果网关不存在，你需要排查为什么 XCP 没有创建配置。在这种情况下，请定位管理平面命名空间中的 &lt;code&gt;mpc&lt;/code&gt; Pod，并查找可能指向错误配置的 Webhook 错误。&lt;/p&gt;
&lt;p&gt;如果网关和虚拟服务已创建，但仍然在 HTTP 请求中获得 &lt;code&gt;50x&lt;/code&gt; 错误，例如以下错误：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;HTTP/2 &lt;span class=&#34;m&#34;&gt;503&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这种情况下，请查看 &lt;code&gt;ingressgateway&lt;/code&gt; 的日志。由于在这种情况下系统配置为 tier1-tier2 设置，因此首先应该检查 &lt;code&gt;tier1gateway&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;查找相应 Pod 的日志。根据问题的性质，你可能需要启用跟踪日志以进行进一步的调查。&lt;/p&gt;
&lt;p&gt;如果你找到以下类似的条目，这意味着无法找到到达 tier2 网关的路由。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;HTTP/2&lt;span class=&#34;s2&#34;&gt;&amp;#34; 503 NR
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果是这种情况，请尝试检查以下内容：&lt;/p&gt;
&lt;h3 id=&#34;确保已应用-nodeselector-注释&#34;&gt;确保已应用 &lt;code&gt;nodeSelector&lt;/code&gt; 注释&lt;/h3&gt;
&lt;p&gt;如果在 XCP-edge 服务中使用 NodePort，请记住你必须在 tier1 和 tier2 中都添加以下注释：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;traffic.istio.io/nodeSelector: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;value&amp;#34;&lt;/span&gt;:&lt;span class=&#34;s2&#34;&gt;&amp;#34;value&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;检查-tier1gateway-配置&#34;&gt;检查 &lt;code&gt;tier1gateway&lt;/code&gt; 配置&lt;/h3&gt;
&lt;p&gt;可以通过将流量路由到特定的集群名称或使用标签来配置 &lt;code&gt;tier1gateway&lt;/code&gt;。确保集群或标签名称在 &lt;a href=&#34;https://docs.tetrate.io/service-bridge/latest/en-us/refs/tsb/gateway/v2/tier1_gateway&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;tier1gateway&lt;/code&gt;&lt;/a&gt; 配置的 &lt;code&gt;spec.externalServers.name[x].clusters&lt;/code&gt; 字段中是正确的。&lt;/p&gt;
&lt;p&gt;你可以使用以下命令获取 &lt;code&gt;tier1gateway&lt;/code&gt; 对象：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl get t1 -w &amp;lt;workspace&amp;gt; -l &amp;lt;gatewaygroup&amp;gt; &amp;lt;name&amp;gt; -o yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  …
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  externalServers:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  - clusters:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    - name: training-cp
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    hostname: bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    …
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  - clusters:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    - labels:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        tier: tier2
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    hostname: httpbin
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    …
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;并将其与 &lt;a href=&#34;https://docs.tetrate.io/service-bridge/latest/en-us/refs/tsb/v2/cluster&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;cluster&lt;/a&gt; 对象进行比较：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl get cluster &amp;lt;name&amp;gt; -o yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;…
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;metadata:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  labels:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    tier: tier2
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  name: training-cp
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;…
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;检查网络之间的通信权限&#34;&gt;检查网络之间的通信权限&lt;/h3&gt;
&lt;p&gt;如果在集群对象中定义了一个 &lt;code&gt;network&lt;/code&gt;，并且参与的集群并不都共享相同的 &lt;code&gt;network&lt;/code&gt;，请检查是否存在一个允许在不同网络之间进行通信的 &lt;a href=&#34;https://docs.tetrate.io/service-bridge/latest/en-us/refs/tsb/v2/organization_setting&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;组织设置&lt;/a&gt;。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl get os
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;修复此问题后，你应该会在命名空间 &lt;code&gt;xcp-multicluster&lt;/code&gt; 中看到创建的服务。该服务条目是为多集群目的而创建的，还会在应用程序命名空间中创建目标规则以设置 mTLS。&lt;/p&gt;
&lt;p&gt;如果此时你仍然注意到从 &lt;code&gt;tier1gateway&lt;/code&gt; 获取到 503 错误，请检查 &lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;错误代码&lt;/a&gt; 以更好地了解可能导致错误的原因。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;在此时使用 &lt;code&gt;istioctl&lt;/code&gt; 命令也非常有用，因为很可能在 tier1 - tier2 情况下，你会遇到下游的某些问题。&lt;/p&gt;
&lt;p&gt;首先，请检查你的 &lt;code&gt;tier1gateway&lt;/code&gt; 的配置是否已同步，检查状态中是否存在 &lt;code&gt;SYNC&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl ps
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;验证你要访问的路由是否存在：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl pc route &amp;lt;ingressgateway&amp;gt;.&amp;lt;namespace&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果路由不存在，那么 &lt;code&gt;tier1gateway&lt;/code&gt; 对象中可能存在配置错误。如果存在，请检查服务的 &lt;code&gt;cluster&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl pc cluster &amp;lt;ingressgateway&amp;gt;.&amp;lt;namespace&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;你应该能够在上述命令的输出中看到子集和目标规则。检查目标规则的配置是否正确。&lt;/p&gt;
&lt;p&gt;最后，请检查 &lt;code&gt;endpoints&lt;/code&gt;。检查配置以查看下游是否正常：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl pc endpoint &amp;lt;ingressgateway&amp;gt;.&amp;lt;namespace&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果所有上述都正确，那么很可能你需要查看 &lt;code&gt;tier2gateway&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;tier1gateway&lt;/code&gt; 的日志中检查是否存在类似以下的错误：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;HTTP/2&lt;span class=&#34;s2&#34;&gt;&amp;#34; 503 LR,URX
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这很可能意味着从 &lt;code&gt;tier1gateway&lt;/code&gt; 到 &lt;code&gt;tier2gateway&lt;/code&gt; 的连接超时。尝试使用 &lt;code&gt;netcat&lt;/code&gt; 查看是否可以访问 &lt;code&gt;tier2gateway&lt;/code&gt;。如果无法成功连接到 &lt;code&gt;tier2gateway&lt;/code&gt;，可能存在配置错误，或者中间可能有阻止通信的防火墙。&lt;/p&gt;
&lt;p&gt;你可能还可以在 &lt;code&gt;ingressgateway&lt;/code&gt; 的日志中找到一些有用的信息。如果你在日志中找到类似以下的错误消息，这意味着 &lt;code&gt;istio-system&lt;/code&gt; 命名空间中的 &lt;a href=&#34;https://istio.io/latest/docs/tasks/security/cert-management/plugin-ca-cert/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;cacert&lt;/code&gt;&lt;/a&gt; 密钥并未由两个集群中的相同根（或中间）CA 签名。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ HTTP/2&lt;span class=&#34;s2&#34;&gt;&amp;#34; 503 UF,URX &amp;#34;&lt;/span&gt;-&lt;span class=&#34;s2&#34;&gt;&amp;#34; &amp;#34;&lt;/span&gt;TLS error: 268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED&lt;span class=&#34;s2&#34;&gt;&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果你对证书进行了更改，你将需要重新启动所有 sidecar 和网关，或者等待 30 分钟，直到组件从 &lt;code&gt;istiod&lt;/code&gt; 获取新证书。这些更新之间的间隔可以配置，但默认值为 30 分钟。&lt;/p&gt;
&lt;h2 id=&#34;tier2gateway-故障排除&#34;&gt;Tier2Gateway 故障排除&lt;/h2&gt;
&lt;p&gt;如果调试 &lt;code&gt;tier1gateway&lt;/code&gt; 不足以解决问题，你将不得不执行与你在 &lt;code&gt;tier2gateway&lt;/code&gt; 上执行的大部分类似的操作，并了解你的问题是否源自配置错误或配置传播问题（即 &lt;code&gt;XCP&lt;/code&gt;）。&lt;/p&gt;
&lt;p&gt;检查是否已在 &lt;code&gt;tier2&lt;/code&gt; 命名空间中创建了网关，可以使用 &lt;code&gt;kubectl get gateway&lt;/code&gt; 进行检查。如果网关不存在，请在 XCP 方面检查。你可以从管理平面命名空间中的 &lt;code&gt;mpc&lt;/code&gt; Pod 中查看是否存在任何 Webhook 问题。&lt;/p&gt;
&lt;p&gt;如果网关已创建，请验证监听器是否正确创建。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl pc listener &amp;lt;ingressgateway&amp;gt;.&amp;lt;namespace&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 &lt;a href=&#34;https://docs.tetrate.io/service-bridge/latest/en-us/refs/install/dataplane/v1alpha1/spec&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;ingressgateway&lt;/code&gt;&lt;/a&gt; 资源中还必须包含端口 15443 的监听器，因为从 &lt;code&gt;tier1&lt;/code&gt; 到 &lt;code&gt;tier2&lt;/code&gt; 的流量将需要使用此端口。还重要的是检查端口 15443 是否在监听器列表的第一个条目中指定，因为一些云供应商会将第一个端口用于负载均衡器的健康检查。&lt;/p&gt;
&lt;p&gt;如果在检查了监听器是否正确创建后，问题仍然存在，你需要检查 &lt;code&gt;tier2gateway&lt;/code&gt; 的日志。如果在这些日志中看到了 &lt;code&gt;50x&lt;/code&gt; 错误，则很可能是应用程序本身存在问题，或者从 &lt;code&gt;istiod&lt;/code&gt; 到 &lt;code&gt;tier2gateway&lt;/code&gt; 的配置传播存在问题。&lt;/p&gt;
&lt;p&gt;如果需要进一步的故障排除，那么你将需要启用跟踪日志以找出根本原因：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl &lt;span class=&#34;nb&#34;&gt;exec&lt;/span&gt; &amp;lt;pod&amp;gt; -c istio-proxy -- pilot-agent request POST ‘logging?level&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;trace&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;你还可以检查是否从 &lt;code&gt;istiod&lt;/code&gt; 接收到配置：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ istioctl ps
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果配置未正确同步，请检查 &lt;code&gt;istiod&lt;/code&gt; 与 `tier2gateway&lt;/p&gt;
&lt;p&gt;` 之间是否有可能阻止通信的任何网络条件。&lt;/p&gt;
&lt;p&gt;还要验证 &lt;code&gt;istiod&lt;/code&gt; 命名空间中的 &lt;code&gt;istiod&lt;/code&gt; Pod 是否正常运行。你可能存在资源问题，可能会阻止配置的发送。&lt;/p&gt;
&lt;p&gt;如果要验证特定主机名的 &lt;code&gt;tier2gateway&lt;/code&gt; 中的所有配置，可以获取配置转储：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl &lt;span class=&#34;nb&#34;&gt;exec&lt;/span&gt; &amp;lt;pod&amp;gt; -c istio-proxy -- pilot-agent request GET config_dump &amp;gt; config_dump.json
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;xcp-故障排除&#34;&gt;XCP 故障排除&lt;/h2&gt;
&lt;p&gt;如果注意到 &lt;code&gt;XCP&lt;/code&gt; 没有创建你期望的配置，请检查管理平面命名空间中 &lt;code&gt;mpc&lt;/code&gt; Pod 的日志。&lt;/p&gt;
&lt;p&gt;在这些日志中，你可能会发现验证错误，指示了从 TSB 转换到 XCP API 的配置存在问题。例如，你可能会看到类似以下的条目：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl logs -n tsb &amp;lt;mpc&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022-03-02T13:58:26.153872Z     error   mpc/config      failed to convert TSB config into its XCP equivalent: no gateway object found &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; reference &lt;span class=&#34;s2&#34;&gt;&amp;#34;httpbin/httpbin-gw&amp;#34;&lt;/span&gt; in &lt;span class=&#34;s2&#34;&gt;&amp;#34;organizations/&amp;lt;org&amp;gt;/tenants/&amp;lt;tenant&amp;gt;/workspaces/&amp;lt;ws&amp;gt;/gatewaygroups/&amp;lt;gg&amp;gt;/virtualservices/&amp;lt;vs&amp;gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果在 &lt;code&gt;mpc&lt;/code&gt; 中没有 Webhook 错误，然后检查集群应用程序命名空间中 &lt;code&gt;edge&lt;/code&gt; Pod 的日志。&lt;/p&gt;
&lt;p&gt;如果一切正常，你应该能够在 &lt;code&gt;istio-system&lt;/code&gt; 命名空间中看到应用于所有配置的日志：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl logs -n istio-system &amp;lt;edge&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022-03-09T11:17:25.492365Z     debug   &lt;span class=&#34;nv&#34;&gt;configapply&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;===&lt;/span&gt;BEGIN: Apply request &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &amp;lt;n&amp;gt; objects in istio-system namespace
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果你要查找的对象在此列表中不存在，那么可能是 &lt;code&gt;XCP edge&lt;/code&gt; 或 &lt;code&gt;XCP central&lt;/code&gt; 中的问题。&lt;/p&gt;
&lt;p&gt;要启用 &lt;code&gt;XCP edge&lt;/code&gt; 的调试日志，你可以对部署进行如下修改（这将重新启动 Pod）：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl edit deployment edge -n istio-system
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;具体取决于你要排查的问题，你可能必须更详细地配置记录器。例如，如果你想为每个记录器配置不同的记录级别，你可以使用以下命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- --log_output_level
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;default:info,transform:info,discovery-server:info,configapply:debug,translator:debug,model:debug,istiod-discovery:error,cluster-gen:error,stream:debug
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;或者，你可以一次性为所有记录器设置日志级别：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- --log_output_level
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- default:debug
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果要永久更改所有未来 &lt;code&gt;XCP edge&lt;/code&gt; 组件的日志记录配置，你可以为控制平面运算符创建一个覆盖：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          overlays:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          - apiVersion: install.xcp.tetrate.io/v1alpha1
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            kind: EdgeXcp
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            name: edge-xcp
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            patches:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            - path: spec.logLevels
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;              value: default:info,transform:info,discovery-server:info,configapply:debug,translator:debug,model:debug,istiod-discovery:error,cluster-gen:error,stream:debug
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;有了调试模式下的 XCP edge，你应该能够看到错误并确定根本原因是否在集群中。如果不在集群中，你将不得不在管理平面命名空间中执行相同的操作以解决 &lt;code&gt;XCP cetnral&lt;/code&gt; 的问题。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Ingress Gateway 故障排除</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/gateway-troubleshooting/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/gateway-troubleshooting/</guid>
      <description>&lt;p&gt;无论我们是使用 TSB 的&lt;code&gt;IngressGateway&lt;/code&gt;还是 Istio 的&lt;code&gt;Gateway&lt;/code&gt;和&lt;code&gt;VirtualService&lt;/code&gt;资源将外部流量路由到我们的服务，都可能会遇到我们暴露的路由问题。在本文档中，我们将展示一些最常见的故障场景以及如何进行故障排查。&lt;/p&gt;
&lt;h2 id=&#34;缺少配置&#34;&gt;缺少配置&lt;/h2&gt;
&lt;p&gt;首先要检查的一件事是我们在 TSB 中创建的配置是否存在于目标集群中。例如，在这种情况下：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ curl -vk http://helloworld.tetrate.io/hello
[ ... ]
&amp;gt; GET /hello HTTP/1.1
&amp;gt; Host: helloworld.tetrate.io
&amp;gt; User-Agent: curl/7.81.0
&amp;gt; Accept: */*
&amp;gt;
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 404 Not Found
&amp;lt; date: Wed, 27 Apr 2022 14:46:41 GMT
&amp;lt; server: istio-envoy
&amp;lt; content-length: 0
&amp;lt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们得到了一个 404 的 HTTP 响应（未找到），对于刚刚配置的入口路由，这是一个问题。要检查的第一件事是&lt;a href=&#34;./configuration_status&#34;&gt;资源状态&lt;/a&gt;。确保你的入口资源的状态为&lt;code&gt;ACCEPTED&lt;/code&gt;。&lt;/p&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;注意 404&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    &lt;p&gt;Envoy 返回的 404 响应不包含正文，如上所示。如果你看到 404 和一些“未找到”的消息，通常表示路由配置正确，但你正在访问错误的 URL。例如：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ curl -vk https://httpbin.tetrate.io/foobar
[ ... ]
&amp;lt; HTTP/2 404
&amp;lt; server: istio-envoy
&amp;lt; date: Wed, 27 Apr 2022 14:53:32 GMT
&amp;lt; content-type: text/html
&amp;lt; content-length: 233
&amp;lt; access-control-allow-origin: *
&amp;lt; access-control-allow-credentials: true
&amp;lt; x-envoy-upstream-service-time: 47
&amp;lt;
&amp;lt;!DOCTYPE HTML PUBLIC &amp;#34;-//W3C//DTD HTML 3.2 Final//EN&amp;#34;&amp;gt;
&amp;lt;title&amp;gt;404 Not Found&amp;lt;/title&amp;gt;
&amp;lt;h1&amp;gt;Not Found&amp;lt;/h1&amp;gt;
&amp;lt;p&amp;gt;The requested URL was not found on the server.  If you entered the URL manually please check your spelling and try again.&amp;lt;/p&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;你在那里看到的 HTML 代码是应用程序本身发送的，这意味着路由正常工作，但你正在访问错误的路径。&lt;/p&gt;

&lt;/div&gt;

&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ tctl experimental status workspace hello --tenant tetrate
NAME     STATUS    LAST EVENT    MESSAGE                                                                                                                  
hello    FAILED                  The following children resources have issues: organizations/tetrate/tenants/tetrate/workspaces/hello/gatewaygroups/hello   
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;例如，上面的输出表明&lt;code&gt;hello&lt;/code&gt;工作区中的某些内容有问题，具体来说是名为&lt;code&gt;hello&lt;/code&gt;的网关组中。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ tctl experimental status gatewaygroup hello --workspace hello --tenant tetrate
NAME     STATUS    LAST EVENT    MESSAGE                                                                                                                                        
hello    FAILED                  The following children resources have issues: organizations/tetrate/tenants/tetrate/workspaces/hello/gatewaygroups/hello/virtualservices/hello    
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;并且在为此路由部署的&lt;code&gt;VirtualService&lt;/code&gt;中似乎存在问题。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ tctl experimental status virtualservice hello --gatewaygroup hello --workspace hello --tenant tetrate
NAME     STATUS    LAST EVENT    MESSAGE                                                                                                                                                          
hello    FAILED    MPC_FAILED    no gateway object found for reference &amp;#34;helloworld/hellogw&amp;#34; in &amp;#34;organizations/tetrate/tenants/tetrate/workspaces/hello/gatewaygroups/hello/virtualservices/hello&amp;#34;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;此时我们可以确定缺少配置的原因实际上是与配置本身有关的问题，因此可以进行修复以使其部署，从而修复我们之前看到的 404 错误。状态对象中的错误消息将引导你找到错误所在。&lt;/p&gt;
&lt;h2 id=&#34;envoy-访问日志&#34;&gt;Envoy 访问日志&lt;/h2&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;X-REQUEST-ID HEADER&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    &lt;p&gt;你可以发送 &lt;code&gt;X-REQUEST-ID&lt;/code&gt; 头以关联日志中的请求。你可以使用任意随机字符串作为请求 ID。Envoy 代理将在其创建的每个日志语句中包含该 ID。以下是示例：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ curl -vk -H &lt;span class=&#34;s2&#34;&gt;&amp;#34;X-REQUEST-ID:4e3e3e04-6509-43d4-9a97-52b7b2cea0e8&amp;#34;&lt;/span&gt; http://helloworld.tetrate.io/hello
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;TSB 配置了 Istio 以便 Envoy 在&lt;code&gt;stdout&lt;/code&gt;中打印访问日志，并仅对特定模块的错误进行记录。如果从&lt;code&gt;istiod&lt;/code&gt;接收到的配置无效，你将会看到一条消息，但对于失败的请求，你将会看到一个带有一些标志的&lt;code&gt;503&lt;/code&gt;响应，这些标志在&lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Envoy 文档&lt;/a&gt;中有说明（请参阅&lt;code&gt;%RESPONSE_FLAGS%&lt;/code&gt;部分）。让我们看看以下示例。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ curl -vk https://httpbin.tetrate.io/foobar
[ ... ]
&amp;lt; HTTP/2 503
&amp;lt; content-length: 19
&amp;lt; content-type: text/plain
&amp;lt; date: Wed, 27 Apr 2022 15:02:19 GMT
&amp;lt; server: istio-envoy
&amp;lt;
no healthy upstream
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果我们查看这个请求的访问日志，我们可以看到：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[2022-04-27T15:02:20.472Z] &amp;#34;GET /foobar HTTP/2&amp;#34; 503 UH no_healthy_upstream - &amp;#34;-&amp;#34; 0 19 0 - &amp;#34;X.X.X.X&amp;#34; &amp;#34;curl/7.81.0&amp;#34; &amp;#34;55fef75a-70e5-449f-ad01-cd34960f465c&amp;#34; &amp;#34;httpbin.tetrate.io&amp;#34; &amp;#34;-&amp;#34; outbound|8000||httpbin.httpbin.svc.cluster.local - 10.16.0.20:8443 X.X.X.X:36009 httpbin.tetrate.io httpbin
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;好的，我们可以看到日志的时间戳，请求的一些 HTTP 信息（方法、路径、协议），然后可以看到响应代码&lt;code&gt;503&lt;/code&gt;，后跟标志&lt;code&gt;UH&lt;/code&gt;，与我们在响应中得到的消息相匹配，说明没有可用的上游服务。当前用于此入口路由的&lt;code&gt;VirtualService&lt;/code&gt;是：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;VirtualService&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;annotations&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;tsb.tetrate.io/organization&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;tetrate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;tsb.tetrate.io/tenant&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;tetrate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;xcp.tetrate.io/workspace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;httpbin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;xcp.tetrate.io/gatewayGroup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;httpbin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;httpbin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;httpbin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;gateways&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;httpbin/httpbingw&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;hosts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;httpbin.tetrate.io&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;httpbin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;route&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;destination&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;host&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;httpbin.httpbin.svc.cluster.local&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果我们检查目标服务&lt;code&gt;httpbin&lt;/code&gt;的端点：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl get ep
NAME              ENDPOINTS                                          AGE
httpbin           &amp;lt;none&amp;gt;                                             48m
httpbin-gateway   10.16.0.20:8080,10.16.0.20:8443,10.16.0.20:15443   48m
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我们没有有效的端点，这是导致问题的原因。接下来的步骤是检查为什么我们的服务没有端点（选择器错误、计算问题等）。&lt;/p&gt;
&lt;h2 id=&#34;调试或跟踪日志&#34;&gt;调试或跟踪日志&lt;/h2&gt;
&lt;p&gt;还有其他情况可能需要提高 Envoy 日志的详细程度，以找出问题所在。假设我们创建了一个应用程序，它执行：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ curl localhost:8090/
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;super funny stuff...
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;然后我们将其部署到我们的服务网格。一旦所有配置就绪，我们发现它实际上无法正常工作&amp;hellip;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ curl -v http://fun.tetrate.io/
[ ... ]
&amp;gt; GET / HTTP/1.1
&amp;gt; Host: fun.tetrate.io
&amp;gt; User-Agent: curl/7.81.0
&amp;gt; Accept: */*
&amp;gt; 
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 502 Bad Gateway
&amp;lt; content-length: 87
&amp;lt; content-type: text/plain
&amp;lt; date: Thu, 28 Apr 2022 11:03:48 GMT
&amp;lt; server: istio-envoy
&amp;lt; x-envoy-upstream-service-time: 3
&amp;lt; 
upstream connect error or disconnect/reset before headers. reset reason: protocol error
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;HTTP 状态代码&lt;code&gt;502&lt;/code&gt;表示“网关错误”，因此问题不应出现在我们的应用程序中。&lt;/p&gt;
&lt;p&gt;检查网关的日志显示：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[2022-04-28T10:58:59.087Z] &amp;#34;GET / HTTP/1.1&amp;#34; 502 - via_upstream - &amp;#34;-&amp;#34; 0 87 3 3 &amp;#34;X.X.X.X&amp;#34; &amp;#34;curl/7.81.0&amp;#34; &amp;#34;3d1f5c5c-e788-4f55-ba0f-00f15b749767&amp;#34; &amp;#34;fun.tetrate.io&amp;#34; &amp;#34;10.16.0.40:8090&amp;#34; outbound|8090||faulty-http.faulty-http.svc.cluster.local 10.16.2.34:50440 10.16.2.34:8080 X.X.X.X:20985 - faulty-http
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;以及 Sidecar 显示：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[2022-04-28T10:58:59.089Z] &amp;#34;GET / HTTP/1.1&amp;#34; 502 UPE upstream_reset_before_response_started{protocol_error} - &amp;#34;-&amp;#34; 0 87 1 - &amp;#34;X.X.X.X&amp;#34; &amp;#34;curl/7.81.0&amp;#34; &amp;#34;3d1f5c5c-e788-4f55-ba0f-00f15b749767&amp;#34; &amp;#34;fun.tetrate.io&amp;#34; &amp;#34;10.16.0.40:8090&amp;#34; inbound|8090|| 127.0.0.6:36281 10.16.0.40:8090 X.X.X.X:0 outbound_.8090_._.faulty-http.faulty-http.svc.cluster.local default
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;好的，在这里我们可以看到 HTTP 状态代码&lt;code&gt;502&lt;/code&gt;以及标志&lt;code&gt;UPE&lt;/code&gt;，根据 Envoy 文档的说明，这表示“上游响应存在 HTTP 协议错误”。好的，但这并没有告诉我们到底发生了什么。&lt;/p&gt;
&lt;p&gt;此时，我们将提高 Envoy 日志的详细程度，以查看到底发生了什么。我们将使用一些&lt;code&gt;tctl&lt;/code&gt;命令的组合来获取与我们的主机 URL 匹配的配置，然后提高相关组件的日志级别。首先，我们要运行的命令是 &lt;code&gt;tctl get all&lt;/code&gt;，以获取与我们的 URL &lt;code&gt;fun.tetrate.io&lt;/code&gt; 相关的配置。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ tctl get all --fqdn fun.tetrate.io &amp;gt; fun.tetrate.io.config.yaml
$ grep -i kind fun.tetrate.io.config.yaml
kind: VirtualService
kind: Gateway
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;为了公开 &lt;code&gt;fun.tetrate.io&lt;/code&gt;，我们正在使用一个 Istio &lt;code&gt;Gateway&lt;/code&gt; 和一个 &lt;code&gt;VirtualService&lt;/code&gt;。现在我们可以运行一个命令，该命令将把与这两个对象相关的 Pod 的日志级别调整为 &lt;code&gt;trace&lt;/code&gt;（我们可以使用 &lt;code&gt;debug&lt;/code&gt;，但是在某些情况下 &lt;code&gt;trace&lt;/code&gt; 可能会提供一些额外的信息），然后我们将指示 &lt;code&gt;tctl&lt;/code&gt; 在我们进行测试时等待，因此它将在测试之后收集日志。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ tctl experimental debug log-level -f fun.tetrate.io.config.yaml --level trace --wait -o /tmp/logs
The following pods were found matching the provided component/file:

 - faulty-http/faulty-http-75cd76d866-x9hqx
 - faulty-http/faulty-http-gw-7fbd455c4c-q8lr8

Do you want to proceed? [y/n]: y
Pod: faulty-http/faulty-http-75cd76d866-x9hqx
active loggers:
  admin: trace
  alternate_protocols_cache: trace
  aws: trace
  assert: trace
[ ... ]

Pod: faulty-http/faulty-http-gw-7fbd455c4c-q8lr8
active loggers:
  admin: trace
  alternate_protocols_cache: trace
  aws: trace
  assert: trace
[ ... ]

Waiting for logs to populate. Press Ctrl+C to stop and dump logs to files...
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;你可以看到 &lt;code&gt;tctl&lt;/code&gt; 标识了两个要更改日志级别的 Pod：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;faulty-http/faulty-http-75cd76d866-x9hqx&lt;/code&gt; 是匹配目标 &lt;code&gt;VirtualService&lt;/code&gt; 中的服务的选择器的一个 Pod。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;faulty-http/faulty-http-gw-7fbd455c4c-q8lr8&lt;/code&gt; 是匹配 Istio &lt;code&gt;Gateway&lt;/code&gt; 对象中的 &lt;code&gt;selector&lt;/code&gt; 的一个 Pod。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;对于这两个 Pod，&lt;code&gt;tctl&lt;/code&gt; 将日志级别更改为指定的 &lt;code&gt;trace&lt;/code&gt; 级别，然后它将挂起等待用户按下 &lt;code&gt;Ctrl+C&lt;/code&gt; 以停止等待日志。此时，我们将在另一个终端中启动并发出我们之前使用过的 &lt;code&gt;curl&lt;/code&gt; 请求几次。之后，我们将返回到运行 &lt;code&gt;tctl&lt;/code&gt; 命令的终端并按下 &lt;code&gt;Ctrl+C&lt;/code&gt;。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Waiting for logs to populate. Press Ctrl+C to stop and dump logs to files...
^C
Dumping pod logs:
- faulty-http/faulty-http-75cd76d866-x9hqx... Done.
- faulty-http/faulty-http-gw-7fbd455c4c-q8lr8... Done.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;结果，我们将在 &lt;code&gt;/tmp/logs&lt;/code&gt; 文件夹中有不同的文件：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ ls -lrt /tmp/logs
-rw-r--r--   1 chirauki  staff       0 28 Apr 16:17 faulty-http-faulty-http-75cd76d866-x9hqx-faulty-http.log
-rw-r--r--   1 chirauki  staff  151797 28 Apr 16:17 faulty-http-faulty-http-75cd76d866-x9hqx-istio-proxy.log
-rw-r--r--   1 chirauki  staff  111970 28 Apr 16:17 faulty-http-faulty-http-gw-7fbd455c4c-q8lr8-istio-proxy.log
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;从上到下，这些是应用程序容器日志，应用程序 sidecar 容器日志和网关日志。让我们检查 sidecar 容器的日志。如果我们在 URL 中搜索主机名 &lt;code&gt;fun.tetrate.io&lt;/code&gt;，我们将看到进入网关的请求：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2022-04-28T14:17:49.024048Z     debug   envoy filter    original_dst: new connection accepted
2022-04-28T14:17:49.024099Z     debug   envoy filter    tls inspector: new connection accepted
2022-04-28T14:17:49.024226Z     trace   envoy filter    tls inspector: recv: 2103
2022-04-28T14:17:49.024265Z     trace   envoy filter    tls:onALPN(), ALPN: istio-peer-exchange,istio
2022-04-28T14:17:49.024291Z     debug   envoy filter    tls:onServerName(), requestedServerName: outbound_.8090_._.faulty-http.faulty-http.svc.cluster.local
2022-04-28T14:17:49.024431Z     trace   envoy misc      enableTimer called on 0x557654f50480 for 3600000ms, min is 3600000ms
2022-04-28T14:17:49.024456Z     debug   envoy conn_handler      [C6169] new connection from 10.16.2.34:41344
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;接着我们将能够看到进入请求的头部：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2022-04-28T14:17:49.025487Z     trace   envoy http      [C6169] completed header: key=host value=fun.tetrate.io
2022-04-28T14:17:49.025503Z     trace   envoy http      [C6169] completed header: key=user-agent value=curl/7.81.0
2022-04-28T14:17:49.025510Z     trace   envoy http      [C6169] completed header: key=accept value=*/*
2022-04-28T14:17:49.025516Z     trace   envoy http      [C6169] completed header: key=x-forwarded-for value=10.132.0.30
2022-04-28T14:17:49.025525Z     trace   envoy http      [C6169] completed header: key=x-forwarded-proto value=http
2022-04-28T14:17:49.025531Z     trace   envoy http      [C6169] completed header: key=x-envoy-internal value=true
2022-04-28T14:17:49.025539Z     trace   envoy http      [C6169] completed header: key=x-request-id value=4e3e3e04-6509-43d4-9a97-52b7b2cea0e8
2022-04-28T14:17:49.025560Z     trace   envoy http      [C6169] completed header: key=x-envoy-decorator-operation value=faulty-http.faulty-http.svc.cluster.local:8090/*
2022-04-28T14:17:49.025577Z     trace   envoy http      [C6169] completed header: key=x-envoy-peer-metadata value=ChQKDkFQUF9DT05UQUlORVJTEgIaAAoUCgpDTFVTVEVSX0lEEgYaBGRlbW8KJAoNSVNUSU9fVkVSU0lPThITGhExLjEyLjQtZmZmMGE5MDg5Mwr0AgoGTEFCRUxTEukCKuYCChcKA2FwcBIQGg5mYXVsdHktaHR0cC1ndwo2CilpbnN0YWxsLm9wZXJhdG9yLmlzdGlvLmlvL293bmluZy1yZXNvdXJjZRIJGgd1bmtub3duChkKBWlzdGlvEhAaDmluZ3Jlc3NnYXRld2F5ChkKDGlzdGlvLmlvL3JldhIJGgdkZWZhdWx0CjAKG29wZXJhdG9yLmlzdGlvLmlvL2NvbXBvbmVudBIRGg9JbmdyZXNzR2F0ZXdheXMKIQoRcG9kLXRlbXBsYXRlLWhhc2gSDBoKN2ZiZDQ1NWM0YwozCh9zZXJ2aWNlLmlzdGlvLmlvL2Nhbm9uaWNhbC1uYW1lEhAaDmZhdWx0eS1odHRwLWd3Ci8KI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEggaBmxhdGVzdAoiChdzaWRlY2FyLmlzdGlvLmlvL2luamVjdBIHGgVmYWxzZQoaCgdNRVNIX0lEEg8aDWNsdXN0ZXIubG9jYWwKKQoETkFNRRIhGh9mYXVsdHktaHR0cC1ndy03ZmJkNDU1YzRjLXE4bHI4ChoKCU5BTUVTUEFDRRINGgtmYXVsdHktaHR0cApWCgVPV05FUhJNGktrdWJlcm5ldGVzOi8vYXBpcy9hcHBzL3YxL25hbWVzcGFjZXMvZmF1bHR5LWh0dHAvZGVwbG95bWVudHMvZmF1bHR5LWh0dHAtZ3cKqwUKEVBMQVRGT1JNX01FVEFEQVRBEpUFKpIFCkAKEGdjcF9nY2VfaW5zdGFuY2USLBoqZ2tlLXRlc3QtbWFzdGVyLWRlZmF1bHQtcG9vbC0zM2Y5ZDBhMi0wb2JkCosBChtnY3BfZ2NlX2luc3RhbmNlX2NyZWF0ZWRfYnkSbBpqcHJvamVjdHMvNzIyMTQ1MjIwNjg3L3pvbmVzL2V1cm9wZS13ZXN0MS1iL2luc3RhbmNlR3JvdXBNYW5hZ2Vycy9na2UtdGVzdC1tYXN0ZXItZGVmYXVsdC1wb29sLTMzZjlkMGEyLWdycAosChNnY3BfZ2NlX2luc3RhbmNlX2lkEhUaEzg2NzA2MDkxNDc3MzExODY3NTgKcwoZZ2NwX2djZV9pbnN0YW5jZV90ZW1wbGF0ZRJWGlRwcm9qZWN0cy83MjIxNDUyMjA2ODcvZ2xvYmFsL2luc3RhbmNlVGVtcGxhdGVzL2drZS10ZXN0LW1hc3Rlci1kZWZhdWx0LXBvb2wtMDA3NzZlYWIKJQoUZ2NwX2drZV9jbHVzdGVyX25hbWUSDRoLdGVzdC1tYXN0ZXIKhwEKE2djcF9na2VfY2x1c3Rlcl91cmwScBpuaHR0cHM6Ly9jb250YWluZXIuZ29vZ2xlYXBpcy5jb20vdjEvcHJvamVjdHMvbWFyYy10ZXN0aW5nLTI2MjQxNC9sb2NhdGlvbnMvZXVyb3BlLXdlc3QxLWIvY2x1c3RlcnMvdGVzdC1tYXN0ZXIKIAoMZ2NwX2xvY2F0aW9uEhAaDmV1cm9wZS13ZXN0MS1iCiQKC2djcF9wcm9qZWN0EhUaE21hcmMtdGVzdGluZy0yNjI0MTQKJAoSZ2NwX3Byb2plY3RfbnVtYmVyEg4aDDcyMjE0NTIyMDY4NwohCg1XT1JLTE9BRF9OQU1FEhAaDmZhdWx0eS1odHRwLWd3
2022-04-28T14:17:49.025590Z     trace   envoy http      [C6169] completed header: key=x-envoy-peer-metadata-id value=router~10.16.2.34~faulty-http-gw-7fbd455c4c-q8lr8.faulty-http~faulty-http.svc.cluster.local
2022-04-28T14:17:49.025594Z     trace   envoy http      [C6169] completed header: key=x-envoy-attempt-count value=1
2022-04-28T14:17:49.025602Z     trace   envoy http      [C6169] completed header: key=x-b3-traceid value=d5a4ba02141b15b1769bf40d0463c3b6
2022-04-28T14:17:49.025606Z     trace   envoy http      [C6169] completed header: key=x-b3-spanid value=769bf40d0463c3b6
2022-04-28T14:17:49.025611Z     trace   envoy http      [C6169] onHeadersCompleteBase
2022-04-28T14:17:49.025614Z     trace   envoy http      [C6169] completed header: key=x-b3-sampled value=0
2022-04-28T14:17:49.025622Z     trace   envoy http      [C6169] Server: onHeadersComplete size=14
2022-04-28T14:17:49.025636Z     trace   envoy http      [C6169] message complete
2022-04-28T14:17:49.025642Z     trace   envoy connection        [C6169] readDisable: disable=true disable_count=0 state=0 buffer_length=2374
2022-04-28T14:17:49.025679Z     debug   envoy http      [C6169][S9387494024320102295] request headers complete (end_stream=true):
&amp;#39;:authority&amp;#39;, &amp;#39;fun.tetrate.io&amp;#39;
&amp;#39;:path&amp;#39;, &amp;#39;/&amp;#39;
&amp;#39;:method&amp;#39;, &amp;#39;GET&amp;#39;
&amp;#39;user-agent&amp;#39;, &amp;#39;curl/7.81.0&amp;#39;
&amp;#39;accept&amp;#39;, &amp;#39;*/*&amp;#39;
&amp;#39;x-forwarded-for&amp;#39;, &amp;#39;10.132.0.30&amp;#39;
&amp;#39;x-forwarded-proto&amp;#39;, &amp;#39;http&amp;#39;
&amp;#39;x-envoy-internal&amp;#39;, &amp;#39;true&amp;#39;
&amp;#39;x-request-id&amp;#39;, &amp;#39;4e3e3e04-6509-43d4-9a97-52b7b2cea0e8&amp;#39;
&amp;#39;x-envoy-decorator-operation&amp;#39;, &amp;#39;faulty-http.faulty-http.svc.cluster.local:8090/*&amp;#39;
&amp;#39;x-envoy-peer-metadata&amp;#39;, &amp;#39;ChQKDkFQUF9DT05UQUlORVJTEgIaAAoUCgpDTFVTVEVSX0lEEgYaBGRlbW8KJAoNSVNUSU9fVkVSU0lPThITGhExLjEyLjQtZmZmMGE5MDg5Mwr0AgoGTEFCRUxTEukCKuYCChcKA2FwcBIQGg5mYXVsdHktaHR0cC1ndwo2CilpbnN0YWxsLm9wZXJhdG9yLmlz
dGlvLmlvL293bmluZy1yZXNvdXJjZRIJGgd1bmtub3duChkKBWlzdGlvEhAaDmluZ3Jlc3NnYXRld2F5ChkKDGlzdGlvLmlvL3JldhIJGgdkZWZhdWx0CjAKG29wZXJhdG9yLmlzdGlvLmlvL2NvbXBvbmVudBIRGg9JbmdyZXNzR2F0ZXdheXMKIQoRcG9kLXRlbXBsYXRlLWhhc2gSDBoKN2ZiZD
Q1NWM0YwozCh9zZXJ2aWNlLmlzdGlvLmlvL2Nhbm9uaWNhbC1uYW1lEhAaDmZhdWx0eS1odHRwLWd3Ci8KI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEggaBmxhdGVzdAoiChdzaWRlY2FyLmlzdGlvLmlvL2luamVjdBIHGgVmYWxzZQoaCgdNRVNIX0lEEg8aDWNsdXN0ZXIu
bG9jYWwKKQoETkFNRRIhGh9mYXVsdHktaHR0cC1ndy03ZmJkNDU1YzRjLXE4bHI4ChoKCU5BTUVTUEFDRRINGgtmYXVsdHktaHR0cApWCgVPV05FUhJNGktrdWJlcm5ldGVzOi8vYXBpcy9hcHBzL3YxL25hbWVzcGFjZXMvZmF1bHR5LWh0dHAvZGVwbG95bWVudHMvZmF1bHR5LWh0dHAtZ3cKqw
UKEVBMQVRGT1JNX01FVEFEQVRBEpUFKpIFCkAKEGdjcF9nY2VfaW5zdGFuY2USLBoqZ2tlLXRlc3QtbWFzdGVyLWRlZmF1bHQtcG9vbC0zM2Y5ZDBhMi0wb2JkCosBChtnY3BfZ2NlX2luc3RhbmNlX2NyZWF0ZWRfYnkSbBpqcHJvamVjdHMvNzIyMTQ1MjIwNjg3L3pvbmVzL2V1cm9wZS13ZXN0
MS1iL2luc3RhbmNlR3JvdXBNYW5hZ2Vycy9na2UtdGVzdC1tYXN0ZXItZGVmYXVsdC1wb29sLTMzZjlkMGEyLWdycAosChNnY3BfZ2NlX2luc3RhbmNlX2lkEhUaEzg2NzA2MDkxNDc3MzExODY3NTgKcwoZZ2NwX2djZV9pbnN0YW5jZV90ZW1wbGF0ZRJWGlRwcm9qZWN0cy83MjIxNDUyMjA2OD
cvZ2xvYmFsL2luc3RhbmNlVGVtcGxhdGVzL2drZS10ZXN0LW1hc3Rlci1kZWZhdWx0LXBvb2wtMDA3NzZlYWIKJQoUZ2NwX2drZV9jbHVzdGVyX25hbWUSDRoLdGVzdC1tYXN0ZXIKhwEKE2djcF9na2VfY2x1c3Rlcl91cmwScBpuaHR0cHM6Ly9jb250YWluZXIuZ29vZ2xlYXBpcy5jb20vdjEv
cHJvamVjdHMvbWFyYy10ZXN0aW5nLTI2MjQxNC9sb2NhdGlvbnMvZXVyb3BlLXdlc3QxLWIvY2x1c3RlcnMvdGVzdC1tYXN0ZXIKIAoMZ2NwX2xvY2F0aW9uEhAaDmV1cm9wZS13ZXN0MS1iCiQKC2djcF9wcm9qZWN0EhUaE21hcmMtdGVzdGluZy0yNjI0MTQKJAoSZ2NwX3Byb2plY3RfbnVtYm
VyEg4aDDcyMjE0NTIyMDY4NwohCg1XT1JLTE9BRF9OQU1FEhAaDmZhdWx0eS1odHRwLWd3&amp;#39;
&amp;#39;x-envoy-peer-metadata-id&amp;#39;, &amp;#39;router~10.16.2.34~faulty-http-gw-7fbd455c4c-q8lr8.faulty-http~faulty-http.svc.cluster.local&amp;#39;
&amp;#39;x-envoy-attempt-count&amp;#39;, &amp;#39;1&amp;#39;
&amp;#39;x-b3-traceid&amp;#39;, &amp;#39;d5a4ba02141b15b1769bf40d0463c3b6&amp;#39;
&amp;#39;x-b3-spanid&amp;#39;, &amp;#39;769bf40d0463c3b6&amp;#39;
&amp;#39;x-b3-sampled&amp;#39;, &amp;#39;0&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;紧接着，我们将看到对应用程序的出站请求。在一些握手消息后，我们将能够看到来自应用程序的入站响应的头部：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2022-04-28T14:17:49.027763Z     trace   envoy http      [C6170] parsing 2548 bytes
2022-04-28T14:17:49.027768Z     trace   envoy http      [C6170] message begin
2022-04-28T14:17:49.027788Z     trace   envoy http      [C6170] completed header: key=X-Header-0 value=value
2022-04-28T14:17:49.027806Z     trace   envoy http      [C6170] completed header: key=X-Header-1 value=value
2022-04-28T14:17:49.027810Z     trace   envoy http      [C6170] completed header: key=X-Header-10 value=value
2022-04-28T14:17:49.027815Z     trace   envoy http      [C6170] completed header: key=X-Header-100 value=value
[ ... ]
2022-04-28T14:17:49.028329Z     trace   envoy http      [C6170] completed header: key=X-Header-8 value=value
2022-04-28T14:17:49.028335Z     trace   envoy http      [C6170] completed header: key=X-Header-80 value=value
2022-04-28T14:17:49.028340Z     trace   envoy http      [C6170] completed header: key=X-Header-81 value=value
2022-04-28T14:17:49.028350Z     debug   envoy client    [C6170] Error dispatching received data: headers count exceeds limit
2022-04-28T14:17:49.028366Z     debug   envoy connection        [C6170] closing data_to_write=0 type=1
2022-04-28T14:17:49.028370Z     debug   envoy connection        [C6170] closing socket: 1
2022-04-28T14:17:49.028450Z     trace   envoy connection        [C6170] raising connection event 1
2022-04-28T14:17:49.028466Z     debug   envoy client    [C6170] disconnect. resetting 1 pending requests
2022-04-28T14:17:49.028478Z     debug   envoy client    [C6170] request reset
2022-04-28T14:17:49.028484Z     trace   envoy main      item added to deferred deletion list (size=1)
2022-04-28T14:17:49.028497Z     debug   envoy router    [C6169][S9387494024320102295] upstream reset: reset reason: protocol error, transport failure reason:
2022-04-28T14:17:49.028555Z     debug   envoy http      [C6169][S9387494024320102295] Sending local reply with details upstream_reset_before_response_started{protocol error}
2022-04-28T14:17:49.028594Z     trace   envoy http      [C6169][S9387494024320102295] encode headers called: filter=0x557655798850 status=0
2022-04-28T14:17:49.028601Z     trace   envoy http      [C6169][S9387494024320102295] encode headers called: filter=0x55765503e2a0 status=0
2022-04-28T14:17:49.028606Z     trace   envoy http      [C6169][S9387494024320102295] encode headers called: filter=0x5576557993b0 status=0
2022-04-28T14:17:49.028628Z     trace   envoy http      [C6169][S9387494024320102295] encode headers called: filter=0x557654ed1420 status=0
2022-04-28T14:17:49.028660Z     debug   envoy http      [C6169][S9387494024320102295] encoding headers via codec (end_stream=false):
&amp;#39;:status&amp;#39;, &amp;#39;502&amp;#39;
&amp;#39;content-length&amp;#39;, &amp;#39;87&amp;#39;
&amp;#39;content-type&amp;#39;, &amp;#39;text/plain&amp;#39;
&amp;#39;x-envoy-peer-metadata&amp;#39;, &amp;#39;Ch8KDkFQUF9DT05UQUlORVJTEg0aC2ZhdWx0eS1odHRwChQKCkNMVVNURVJfSUQSBhoEZGVtbwokCg1JU1RJT19WRVJTSU9OEhMaETEuMTIuNC1mZmYwYTkwODkzCtABCgZMQUJFTFMSxQEqwgEKFAoDYXBwEg0aC2ZhdWx0eS1odHRwCiEKEXBvZC10ZW1wbGF0
ZS1oYXNoEgwaCjc1Y2Q3NmQ4NjYKJAoZc2VjdXJpdHkuaXN0aW8uaW8vdGxzTW9kZRIHGgVpc3RpbwowCh9zZXJ2aWNlLmlzdGlvLmlvL2Nhbm9uaWNhbC1uYW1lEg0aC2ZhdWx0eS1odHRwCi8KI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEggaBmxhdGVzdAobCgdNRVNIX0
lEEhAaDmRlbW8udHNiLmxvY2FsCiYKBE5BTUUSHhocZmF1bHR5LWh0dHAtNzVjZDc2ZDg2Ni14OWhxeAoaCglOQU1FU1BBQ0USDRoLZmF1bHR5LWh0dHAKUwoFT1dORVISShpIa3ViZXJuZXRlczovL2FwaXMvYXBwcy92MS9uYW1lc3BhY2VzL2ZhdWx0eS1odHRwL2RlcGxveW1lbnRzL2ZhdWx0
eS1odHRwCqsFChFQTEFURk9STV9NRVRBREFUQRKVBSqSBQpAChBnY3BfZ2NlX2luc3RhbmNlEiwaKmdrZS10ZXN0LW1hc3Rlci1kZWZhdWx0LXBvb2wtMzNmOWQwYTItZnpobAqLAQobZ2NwX2djZV9pbnN0YW5jZV9jcmVhdGVkX2J5EmwaanByb2plY3RzLzcyMjE0NTIyMDY4Ny96b25lcy9ldX
JvcGUtd2VzdDEtYi9pbnN0YW5jZUdyb3VwTWFuYWdlcnMvZ2tlLXRlc3QtbWFzdGVyLWRlZmF1bHQtcG9vbC0zM2Y5ZDBhMi1ncnAKLAoTZ2NwX2djZV9pbnN0YW5jZV9pZBIVGhM0NjQ3OTQ3MDc3NTU5ODE3NTY5CnMKGWdjcF9nY2VfaW5zdGFuY2VfdGVtcGxhdGUSVhpUcHJvamVjdHMvNzIy
MTQ1MjIwNjg3L2dsb2JhbC9pbnN0YW5jZVRlbXBsYXRlcy9na2UtdGVzdC1tYXN0ZXItZGVmYXVsdC1wb29sLTAwNzc2ZWFiCiUKFGdjcF9na2VfY2x1c3Rlcl9uYW1lEg0aC3Rlc3QtbWFzdGVyCocBChNnY3BfZ2tlX2NsdXN0ZXJfdXJsEnAabmh0dHBzOi8vY29udGFpbmVyLmdvb2dsZWFwaX
MuY29tL3YxL3Byb2plY3RzL21hcmMtdGVzdGluZy0yNjI0MTQvbG9jYXRpb25zL2V1cm9wZS13ZXN0MS1iL2NsdXN0ZXJzL3Rlc3QtbWFzdGVyCiAKDGdjcF9sb2NhdGlvbhIQGg5ldXJvcGUtd2VzdDEtYgokCgtnY3BfcHJvamVjdBIVGhNtYXJjLXRlc3RpbmctMjYyNDE0CiQKEmdjcF9wcm9q
ZWN0X251bWJlchIOGgw3MjIxNDUyMjA2ODcKHgoNV09SS0xPQURfTkFNRRINGgtmYXVsdHktaHR0cA==&amp;#39;
&amp;#39;x-envoy-peer-metadata-id&amp;#39;, &amp;#39;sidecar~10.16.0.40~faulty-http-75cd76d866-x9hqx.faulty-http~faulty-http.svc.cluster.local&amp;#39;
&amp;#39;date&amp;#39;, &amp;#39;Thu, 28 Apr 2022 14:17:48 GMT&amp;#39;
&amp;#39;server&amp;#39;, &amp;#39;istio-envoy&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;好的，等等。我们看到 Envoy 开始解析响应头部，但最终打印了这行：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2022-04-28T14:17:49.028350Z     debug   envoy client    [C6170] Error dispatching received data: headers count exceeds limit
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;以某种方式，响应中的头部似乎比 Envoy 希望的多。如果我们搜索&lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#config-core-v3-httpprotocoloptions&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Envoy 文档&lt;/a&gt;（特别是检查 &lt;code&gt;max_headers_count&lt;/code&gt;），我们会看到，默认情况下，Envoy 允许一个 HTTP 请求或响应中的最多 100 个头部，而我们超过了这个数字。在这种情&lt;/p&gt;
&lt;p&gt;况下，应用程序中的问题会导致 Envoy 出现错误，因此修复应用程序将解决此问题。&lt;/p&gt;
&lt;p&gt;此时，我们可以再次使用 &lt;code&gt;tctl&lt;/code&gt; 将日志级别恢复为默认值。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ tctl experimental debug log-level -f fun.tetrate.io.config.yaml --level info -y
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;gateway-自动缩放和删除&#34;&gt;Gateway 自动缩放和删除&lt;/h2&gt;
&lt;p&gt;当发生网关 Pod 删除事件时，TSB 需要将服务信息传播到其他集群，以便跨集群流量不会针对已删除的 Pod 的 NodePort IP 地址。你可以配置 TSB 控制平面以启用一个 Webhook，拦截网关 Pod 删除事件，将删除操作保留一段可配置的时间。这样可以为配置更改在所有集群中传播并让所有网格组件删除即将删除的 IP 地址提供足够的时间。如果配置未完全传播，你可能会观察到 HTTP 流量的&lt;code&gt;503&lt;/code&gt;错误或通过传递跨集群流量的&lt;code&gt;000&lt;/code&gt;错误。&lt;/p&gt;
&lt;p&gt;请参阅&lt;a href=&#34;../../operations/features/gateway-deletion-webhook&#34;&gt;网关删除保持 Webhook&lt;/a&gt;以启用 Webhook。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>配置状态故障排除</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/configuration-status/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/configuration-status/</guid>
      <description>&lt;p&gt;Tetrate Service Bridge 的 tctl CLI 允许你与 TSB API 交互以应用对象的配置。本文档介绍如何使用 tctl 了解系统中资源配置的部署状态。&lt;/p&gt;
&lt;h2 id=&#34;资源状态&#34;&gt;资源状态&lt;/h2&gt;
&lt;p&gt;TSB 通过 ResourceStatus 跟踪配置更改的生命周期。你可以使用 &lt;a href=&#34;../../reference/cli/reference/experimental#tctl-experimental-status&#34;&gt;tctl x status&lt;/a&gt; 获取它们。运行 &lt;code&gt;tctl x status --help&lt;/code&gt; 可查看所有可能的选项。&lt;/p&gt;
&lt;p&gt;根据资源的配置状态计算方式，有不同类型的资源。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;资源类型&lt;/th&gt;
&lt;th&gt;配置状态&lt;/th&gt;
&lt;th&gt;示例&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;父资源&lt;/td&gt;
&lt;td&gt;聚合其子资源的状态。&lt;/td&gt;
&lt;td&gt;&lt;code&gt;workspace&lt;/code&gt;, &lt;code&gt;trafficgroup&lt;/code&gt;, &lt;code&gt;gatewaygroup&lt;/code&gt;, &lt;code&gt;securitygroup&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;子资源&lt;/td&gt;
&lt;td&gt;不依赖于其他资源。&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ingressgateway&lt;/code&gt;, &lt;code&gt;egressgateway&lt;/code&gt;, &lt;code&gt;trafficsettings&lt;/code&gt; 等&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;不可配置资源&lt;/td&gt;
&lt;td&gt;不会直接在目标集群中实体化为配置。&lt;/td&gt;
&lt;td&gt;&lt;code&gt;organizations&lt;/code&gt;, &lt;code&gt;tenants&lt;/code&gt;, &lt;code&gt;users&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;具有依赖关系的资源&lt;/td&gt;
&lt;td&gt;高级别资源。&lt;/td&gt;
&lt;td&gt;&lt;code&gt;applications&lt;/code&gt; 和 &lt;code&gt;apis&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;资源状态可以具有多个值，这取决于其配置在&lt;a href=&#34;../../concepts/architecture&#34;&gt;TSB 组件&lt;/a&gt;中的传播程度。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;类型&lt;/th&gt;
&lt;th&gt;状态&lt;/th&gt;
&lt;th&gt;条件&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;子资源和不可配置资源&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ACCEPTED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;它们的配置已经通过验证并持久化。这是对有效配置的初始值。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;READY&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;它们的配置已传播到所有目标集群。这也是不可配置资源的默认状态。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;PARTIAL&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;其中一些配置在某些目标集群中是就绪的，但在其中一些目标集群中不是。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;FAILED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;它们的配置在一些或所有目标集群中触发了一些内部错误。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;FAILED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;目标集群中的某个问题资源会影响配置的正确行为。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;父资源&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ACCEPTED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;它们的所有子资源都是 &lt;code&gt;ACCEPTED&lt;/code&gt; 或 &lt;code&gt;READY&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;READY&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;它们的所有子资源都是 &lt;code&gt;READY&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;FAILED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;它们的任何子资源都是 &lt;code&gt;FAILED&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;具有依赖关系的资源&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ACCEPTED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;其所有依赖配置都是 &lt;code&gt;ACCEPTED&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;READY&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;其所有依赖配置都是 &lt;code&gt;READY&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;DIRTY&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;其所有依赖配置都是 &lt;code&gt;DIRTY&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;FAILED&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;其任何依赖配置都是 &lt;code&gt;FAILED&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;PARTIAL&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;其依赖配置处于 &lt;code&gt;READY&lt;/code&gt;, &lt;code&gt;ACCEPTED&lt;/code&gt; 和/或 &lt;code&gt;DIRTY&lt;/code&gt; 的混合状态。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;你可以在 &lt;a href=&#34;../../refs/tsb/v2/status#status&#34;&gt;状态 API 规范&lt;/a&gt; 中了解更多关于状态类型的信息。&lt;/p&gt;
&lt;h2 id=&#34;使用-tctl-了解配置对象的状态&#34;&gt;使用 tctl 了解配置对象的状态&lt;/h2&gt;
&lt;p&gt;让我们在部署了 &lt;code&gt;bookinfo&lt;/code&gt; 应用程序的情况下，看看一些示例。&lt;/p&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;提示&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    我们假设 Bookinfo 应用程序已在其自己的工作区中部署，就像在我们的 &lt;a href=&#34;../../quickstart/introduction&#34;&gt;快速入门&lt;/a&gt; 教程中一样，并已配置相应的组。
&lt;/div&gt;

&lt;p&gt;你可以使用 &lt;code&gt;tctl x status&lt;/code&gt; 检查 &lt;code&gt;bookinfo&lt;/code&gt; 入口网关的状态：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x status ig --tenant tetrate --workspace bookinfo --gatewaygroup bookinfo bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;NAME        STATUS      LAST EVENT      MESSAGE
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;bookinfo    ACCEPTED    XCP_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这显示其配置已被验证并持久化。&lt;/p&gt;
&lt;p&gt;如果你想获取更多信息，它的 YAML 版本将显示此资源状态的事件历史记录。这些信息对于排查资源配置的生命周期非常有用。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x status ig --tenant tetrate --workspace bookinfo --gatewaygroup bookinfo bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;apiVersion: api.tsb.tetrate.io/v2
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kind: ResourceStatus
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;metadata:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  group: bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  name: bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  organization: tetrate
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tenant: tetrate
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  workspace: bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;spec:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  configEvents:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    events:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    - etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;sMlEWPbvm6M=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      timestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-02-10T16:54:14.710165091Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      type: XCP_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    - etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;sMlEWPbvm6M=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      timestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-02-10T16:54:14.649002805Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      type: MPC_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    - etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;sMlEWPbvm6M=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      timestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-02-10T16:54:10.453242255Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      type: TSB_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  status: ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这里，你可以看到更改了最后一个版本 &lt;code&gt;sMlEWPbvm6M=&lt;/code&gt; 的此 &lt;code&gt;ingressgateway&lt;/code&gt; 资源的状态的事件历史记录，最近的事件排在最前面。&lt;/p&gt;
&lt;p&gt;在此示例中，资源首先被 TSB 服务器接受，然后是 MPC，最后是 XCP 组件。&lt;/p&gt;
&lt;p&gt;请注意，只有最新资源版本的历史记录会被保留。在接下来的部分中，你将学会如何使用审计日志来显示所有版本的历史记录。&lt;/p&gt;
&lt;h2 id=&#34;使用-tsb-审计日志了解配置对象的生命周期&#34;&gt;使用 TSB 审计日志了解配置对象的生命周期&lt;/h2&gt;
&lt;p&gt;TSB 有一个称为审计日志的概念，显示了发生在 TSB 资源上的所有事件。谁在何时对每个资源进行了什么操作，它还可以提供有关其配置的不同阶段的见解。&lt;/p&gt;
&lt;p&gt;例如，你可以使用以下命令获取在 bookinfo 工作区中发生的所有事件的列表以及其中包含的所有资源。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x audit ws bookinfo --recursive --text bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;TIME                   SEVERITY    TYPE                                        OPERATION               USER     MESSAGE
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:53    INFO        api.tsb.tetrate.io/v2/ResourceStatus        XCP_CENTRAL_ACCEPTED    mpc      New ACCEPTED status due to XCP_CENTRAL_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; trafficgroup &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;oxil15u6bfw=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:53    INFO        api.tsb.tetrate.io/v2/ResourceStatus        XCP_CENTRAL_ACCEPTED    mpc      New ACCEPTED status due to XCP_CENTRAL_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; securitygroup &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;gEUA3cK7+YI=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; ingressgateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;sMlEWPbvm6M=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; trafficgroup &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;oxil15u6bfw=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        XCP_CENTRAL_ACCEPTED    mpc      New ACCEPTED status due to XCP_CENTRAL_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; workspace &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;GBcgtWe3R80=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        XCP_CENTRAL_REJECTED    mpc      New ACCEPTED status due to XCP_CENTRAL_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; gatewaygroup &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;y6q054gFZCQ=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; securitygroup &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;gEUA3cK7+YI=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; workspace &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;GBcgtWe3R80=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; gatewaygroup &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;y6q054gFZCQ=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 17:02:48    INFO        gateway.tsb.tetrate.io/v2/IngressGateway    create                  admin    Create IngressGateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; by &lt;span class=&#34;s2&#34;&gt;&amp;#34;admin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;审核日志中标识了一些错误，你可以通过检索那些对象的配置状态的详细信息来进一步检查这些错误：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x status ig --workspace bookinfo --gatewaygroup bookinfo bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;NAME        STATUS    LAST EVENT              MESSAGE
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;bookinfo    FAILED    XCP_CENTRAL_REJECTED    admission webhook &lt;span class=&#34;s2&#34;&gt;&amp;#34;central-validation.xcp.tetrate.io&amp;#34;&lt;/span&gt; denied the request: configuration is invalid: domain name &lt;span class=&#34;s2&#34;&gt;&amp;#34;tetrate.io---&amp;#34;&lt;/span&gt; invalid &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;label &lt;span class=&#34;s2&#34;&gt;&amp;#34;io---&amp;#34;&lt;/span&gt; invalid&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;正如你在命令输出中所看到的，配置已被 XCP 组件拒绝，并标记为无效，它将不会传播到目标集群。&lt;/p&gt;
&lt;p&gt;你还可以通过查询工作区的状态来获取见解。它将显示其子资源中的任何错误。通过这种方式，从任何工作区或顶级元素轻松导航到配置对象可能存在的特定错误非常容易。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x status ws bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;NAME        STATUS    LAST EVENT    MESSAGE
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;bookinfo    FAILED                  The following children are failing: organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;或其扩展的 YAML 版本：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x status ws bookinfo -o yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;apiVersion: api.tsb.tetrate.io/v2
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kind: ResourceStatus
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;metadata:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  name: bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  organization: tetrate
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tenant: tetrate
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;spec:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  aggregatedStatus:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    children:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        message: &lt;span class=&#34;s1&#34;&gt;&amp;#39;The following children resources have issues: organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo/ingressgateways/bookinfo&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        status: FAILED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      organizations/tetrate/tenants/tetrate/workspaces/bookinfo/securitygroups/bookinfo:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        status: ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      organizations/tetrate/tenants/tetrate/workspaces/bookinfo/trafficgroups/bookinfo:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        status: ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    configEvents:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      events:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      - etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;GBcgtWe3R80=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        timestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-02-10T18:32:29.593869622Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        type: XCP_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      - etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;GBcgtWe3R80=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        timestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-02-10T18:32:29.576374660Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        type: MPC_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      - etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;GBcgtWe3R80=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        timestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-02-10T18:32
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;:24.679197258Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        type: TSB_ACCEPTED
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  message: &lt;span class=&#34;s1&#34;&gt;&amp;#39;The following children resources have issues: organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  status: FAILED
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;最后，审计日志帮助轻松识别配置问题是何时引入的，以及在任何时间点应用的确切更改。在这里，你可以清楚地看到一个对管理员的更新触发了配置资源的更改，并且可以看到导致问题的确切字段：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x audit ig --workspace bookinfo --gatewaygroup bookinfo bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;TIME                   SEVERITY    TYPE                                        OPERATION               USER     MESSAGE
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 22:04:14    INFO        api.tsb.tetrate.io/v2/ResourceStatus        XCP_CENTRAL_REJECTED    mpc      New FAILED status due to XCP_CENTRAL_REJECTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; ingressgateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;O0HhTEHkvjA=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10/22:04:14    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; ingressgateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;O0HhTEHkvjA=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2022/02/10 22:04:12    INFO        gateway.tsb.tetrate.io/v2/IngressGateway    update                  admin    Update IngressGateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; by &lt;span class=&#34;s2&#34;&gt;&amp;#34;admin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2021/11/25 16:02:53    INFO        api.tsb.tetrate.io/v2/ResourceStatus        XCP_CENTRAL_ACCEPTED    mpc      New ACCEPTED status due to XCP_CENTRAL_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; ingressgateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;sMlEWPbvm6M=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2021/11/25 16:02:52    INFO        api.tsb.tetrate.io/v2/ResourceStatus        MPC_ACCEPTED            mpc      New ACCEPTED status due to MPC_ACCEPTED event &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; ingressgateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; version &lt;span class=&#34;s2&#34;&gt;&amp;#34;sMlEWPbvm6M=&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2021/11/25 16:02:48    INFO        gateway.tsb.tetrate.io/v2/IngressGateway    create                  admin    Create IngressGateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; by &lt;span class=&#34;s2&#34;&gt;&amp;#34;admin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;以日期过滤器显示 yaml 将输出：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ tctl x audit ig --workspace bookinfo --gatewaygroup bookinfo bookinfo --operation update --since &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022/02/10 22:04:12&amp;#34;&lt;/span&gt; -o yaml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;apiVersion: audit.tetrate.io/v1
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kind: AuditLog
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;metadata: &lt;span class=&#34;o&#34;&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;spec:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  createTime: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2021-12-13T22:11:32Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  fqn: organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo/ingressgateways/bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  kind: gateway.tsb.tetrate.io/v2/IngressGateway
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  message: Update IngressGateway &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt; by &lt;span class=&#34;s2&#34;&gt;&amp;#34;admin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  operation: update
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  properties:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    diff: &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;2-
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;       &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        Fqn: &lt;span class=&#34;s2&#34;&gt;&amp;#34;organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo/ingressgateways/bookinfo&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      - Etag: &lt;span class=&#34;s2&#34;&gt;&amp;#34;\&amp;#34;sMlEWPbvm6M=\&amp;#34;&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      + Etag: &lt;span class=&#34;s2&#34;&gt;&amp;#34;\&amp;#34;O0HhTEHkvjA=\&amp;#34;&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        WorkloadSelector: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Namespace: &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Labels: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          app: &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo-gateway&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        Http: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      -   Name: &lt;span class=&#34;s2&#34;&gt;&amp;#34;productpage&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      +   Name: &lt;span class=&#34;s2&#34;&gt;&amp;#34;productpage-invalid&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          Port: 80,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      -   Hostname: &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo.tetrate.io&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      +   Hostname: &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo.tetrate.io=--&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          Routing: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;           Rules: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;             RouteOrRedirect: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;              Route: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;               Host: &lt;span class=&#34;s2&#34;&gt;&amp;#34;bookinfo/productpage.bookinfo.svc.cluster.local&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;               Port: 9080,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;              &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;             &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;           &lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;       &lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    display-name: &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    etag: &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#34;O0HhTEHkvjA=&amp;#34;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    fqn: organizations/tetrate/tenants/tetrate/workspaces/bookinfo/gatewaygroups/bookinfo/ingressgateways/bookinfo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  severity: INFO
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  triggeredBy: admin
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;你可以很容易地以 &lt;code&gt;diff&lt;/code&gt; 格式看到确切更改的字段。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Cluster onboarding troubleshooting</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/cluster-onboarding/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/cluster-onboarding/</guid>
      <description>&lt;p&gt;This document explains most common issues when onboarding new control planes into TSB.&lt;/p&gt;
&lt;h2 id=&#34;connectivity&#34;&gt;Connectivity&lt;/h2&gt;
&lt;p&gt;The deployment &lt;code&gt;tsb-operator-control-plane&lt;/code&gt; needs to have connectivity with the management plane URL. Communication is performed to
the &lt;code&gt;front-envoy&lt;/code&gt; component in the &lt;code&gt;tsb&lt;/code&gt; namespace, which is served by the &lt;code&gt;envoy&lt;/code&gt; service.&lt;/p&gt;
&lt;p&gt;Make sure that the control plane can reach it and it&amp;rsquo;s not blocked by network policies, security groups or any firewall.&lt;/p&gt;
&lt;h2 id=&#34;troubleshooting&#34;&gt;Troubleshooting&lt;/h2&gt;
&lt;p&gt;Once you&amp;rsquo;ve applied the &lt;a href=&#34;../setup/helm/controlplane#secrets-configuration&#34;&gt;necessary secrets&lt;/a&gt;, installed the control plane operator
and created the control plane CR, if there&amp;rsquo;s some misconfiguration, some pods won&amp;rsquo;t be able to start. Always check for &lt;code&gt;tsb-operator-control-plane&lt;/code&gt;
logs, as it will give more information about what could be wrong.&lt;/p&gt;
&lt;h3 id=&#34;service-account-issues&#34;&gt;Service account issues&lt;/h3&gt;
&lt;p&gt;If the service account to generate the tokens is not created, you&amp;rsquo;ll get the following error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;error	controlplane	token rotation failed, retrying in 15m0s: secret istio-system/cluster-service-account not found: Secret &lt;span class=&#34;s2&#34;&gt;&amp;#34;cluster-service-account&amp;#34;&lt;/span&gt; not found &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;scope&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;controlplane&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Or it can also happen that it is not correctly configured:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;error	controlplane	token rotation failed, retrying in 15m0s: cluster has been configured with incorrect service account secret. ControlPlane CR has cluster name &lt;span class=&#34;s2&#34;&gt;&amp;#34;demo&amp;#34;&lt;/span&gt;, but service account secret has &lt;span class=&#34;s2&#34;&gt;&amp;#34;organizations/tetrate/clusters/not-demo&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;scope&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;controlplane&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this example, we&amp;rsquo;ve created a cluster object called &lt;code&gt;demo&lt;/code&gt;, but in the CP we&amp;rsquo;re generating the service account for a cluster called &lt;code&gt;not-demo&lt;/code&gt;.
To fix this issue you&amp;rsquo;ll need to add the cluster name and service account token to the &lt;code&gt;values.yaml&lt;/code&gt; file to install the CP. First generate the token:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install cluster-service-account --cluster demo &amp;gt; /tmp/demo.jwk
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And then configure the &lt;code&gt;values.yaml&lt;/code&gt; file with the cluster name and the JWK file:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;secrets&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;tsb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;clusterServiceAccount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;clusterFQN&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;organizations/tetrate/clusters/demo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;JWK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;sd&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{{ .Secrets.ClusterServiceAccount.JWK }}&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The cluster name needs to match with the cluster name added in the control plane CR under &lt;code&gt;spec.managementPlane.clusterName&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;:::note
Remember to restart the &lt;code&gt;tsb-operator-control-plane&lt;/code&gt; pod to generate the secrets, and once generated, restart the control plane pods.
:::&lt;/p&gt;
&lt;h3 id=&#34;control-plane-certificate-issues&#34;&gt;Control plane certificate issues&lt;/h3&gt;
&lt;p&gt;If the certificate &lt;code&gt;tsb-certs&lt;/code&gt; configured in the management plane don&amp;rsquo;t contain the correct URI SAN which is configured in
the control plane CR under &lt;code&gt;spec.managementPlane.host&lt;/code&gt;, or both &lt;code&gt;tsb-certs&lt;/code&gt; in &lt;code&gt;tsb&lt;/code&gt; namespace and &lt;code&gt;mp-cert&lt;/code&gt; in &lt;code&gt;istio-system&lt;/code&gt;
namespace doesn&amp;rsquo;t contain the same URI SAN, or are not signed by the same root/intermediate CA you&amp;rsquo;ll get the following error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;error	controlplane	token rotation failed, retrying in 7.153870785s: generate tokens: rpc error: &lt;span class=&#34;nv&#34;&gt;code&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; Unavailable &lt;span class=&#34;nv&#34;&gt;desc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; connection error: &lt;span class=&#34;nv&#34;&gt;desc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate is valid for demo.tsb.tetrate.io, not tsb.tetrate.io&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;scope&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;controlplane&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can update the &lt;code&gt;mp-cert&lt;/code&gt; by configuring the value &lt;code&gt;secrets.tsb.cacert&lt;/code&gt; in your control plane &lt;code&gt;values.yaml&lt;/code&gt; file, or update
the &lt;code&gt;tsb-certs&lt;/code&gt; by configuring the values &lt;code&gt;secrets.tsb.cert&lt;/code&gt; and &lt;code&gt;secrets.tsb.key&lt;/code&gt; in the management plane &lt;code&gt;values.yaml&lt;/code&gt; file.&lt;/p&gt;
&lt;p&gt;If the certificate provided in &lt;code&gt;tsb-certs&lt;/code&gt; is signed by a public CA such as Digicert or Let’s Encrypt you can let the default values
for the control plane CR, but if this certificate is signed by an internal CA or it&amp;rsquo;s self signed you can get the following error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;error	controlplane	token rotation failed, retrying in 1.661766738s: generate tokens: rpc error: &lt;span class=&#34;nv&#34;&gt;code&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; Unavailable &lt;span class=&#34;nv&#34;&gt;desc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; connection error: &lt;span class=&#34;nv&#34;&gt;desc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;transport: authentication handshake failed: x509: certificate signed by unknown authority&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;scope&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;controlplane&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If that&amp;rsquo;s the case, you&amp;rsquo;ll need to modify the control plane CR to set &lt;code&gt;spec.managementPlane.selfSigned&lt;/code&gt; to &lt;code&gt;true&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;:::note
Remember to restart the &lt;code&gt;tsb-operator-control-plane&lt;/code&gt; pod to generate the secrets, and once generated, restart the control plane pods.
:::&lt;/p&gt;
&lt;h3 id=&#34;xcp-connection-issues&#34;&gt;XCP connection issues&lt;/h3&gt;
&lt;p&gt;If the newly onboarded cluster it&amp;rsquo;s not reporting the cluster status or new configurations applied are not being created in the cluster,
check the &lt;code&gt;edge&lt;/code&gt; pod logs in &lt;code&gt;istio-system&lt;/code&gt; namespace, as even if the pod is running, it is possible that it&amp;rsquo;s having some issues. For example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;warn	stream	error getting stream. retrying in 21.72809085s: rpc error: &lt;span class=&#34;nv&#34;&gt;code&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; Unavailable &lt;span class=&#34;nv&#34;&gt;desc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; connection error: &lt;span class=&#34;nv&#34;&gt;desc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate is valid for xcp.tetrate.io, not tsb.tetrate.io&amp;#34;&lt;/span&gt;	&lt;span class=&#34;nv&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;configs-4d116fd6
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this case the &lt;code&gt;xcp-central-cert&lt;/code&gt; in &lt;code&gt;tsb&lt;/code&gt; namespace is configured for &lt;code&gt;xcp.tetrate.io&lt;/code&gt; but the host configured in the control plane
CR is &lt;code&gt;tsb.tetrate.io&lt;/code&gt;. To update the certificate, you&amp;rsquo;ll need to update the management plane &lt;code&gt;values.yaml&lt;/code&gt; &lt;a href=&#34;../setup/helm/managementplane#xcp-secrets-configuration&#34;&gt;accordingly to this&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If &lt;code&gt;edge&lt;/code&gt; is unable to start you can describe to pod in order to get more information. Sometimes it couldn&amp;rsquo;t start due to:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  Warning  FailedMount  7m15s &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;x7 over 7m47s&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;  kubelet            MountVolume.SetUp failed &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; volume &lt;span class=&#34;s2&#34;&gt;&amp;#34;xcp-central-auth-jwt&amp;#34;&lt;/span&gt; : secret &lt;span class=&#34;s2&#34;&gt;&amp;#34;xcp-edge-central-auth-token&amp;#34;&lt;/span&gt; not found
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  Warning  FailedMount  5m44s                  kubelet            Unable to attach or mount volumes: unmounted &lt;span class=&#34;nv&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=[&lt;/span&gt;xcp-central-auth-ca&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;, unattached &lt;span class=&#34;nv&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=[&lt;/span&gt;config-map-volume xcp-central-auth-jwt xcp-central-auth-ca xcp-edge-webhook-ca kube-api-access-hxk8l webhook-certs&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: timed out waiting &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the condition
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  Warning  FailedMount  3m26s                  kubelet            Unable to attach or mount volumes: unmounted &lt;span class=&#34;nv&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=[&lt;/span&gt;xcp-central-auth-ca&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;, unattached &lt;span class=&#34;nv&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=[&lt;/span&gt;xcp-edge-webhook-ca kube-api-access-hxk8l webhook-certs config-map-volume xcp-central-auth-jwt xcp-central-auth-ca&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: timed out waiting &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the condition
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  Warning  FailedMount  95s &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;x11 over 7m47s&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;   kubelet            MountVolume.SetUp failed &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; volume &lt;span class=&#34;s2&#34;&gt;&amp;#34;xcp-central-auth-ca&amp;#34;&lt;/span&gt; : secret &lt;span class=&#34;s2&#34;&gt;&amp;#34;xcp-central-ca-bundle&amp;#34;&lt;/span&gt; not found
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  Warning  FailedMount  69s                    kubelet            Unable to attach or mount volumes: unmounted &lt;span class=&#34;nv&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=[&lt;/span&gt;xcp-central-auth-ca&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;, unattached &lt;span class=&#34;nv&#34;&gt;volumes&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=[&lt;/span&gt;kube-api-access-hxk8l webhook-certs config-map-volume xcp-central-auth-jwt xcp-central-auth-ca xcp-edge-webhook-ca&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: timed out waiting &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the condition
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This error is because the secret &lt;code&gt;xcp-central-ca-bundle&lt;/code&gt; in &lt;code&gt;istio-system&lt;/code&gt; namespace don&amp;rsquo;t exist. This secret must contain the same URI SAN and must
be signed by the same root/intermediate CA as &lt;code&gt;xcp-central-cert&lt;/code&gt; in &lt;code&gt;tsb&lt;/code&gt; namespace. In order to configure this secret, you&amp;rsquo;ll need to update the value
&lt;code&gt;secrets.xcp.rootca&lt;/code&gt; from your control plane &lt;code&gt;values.yaml&lt;/code&gt; file.&lt;/p&gt;
&lt;p&gt;:::note
Remember to restart the &lt;code&gt;tsb-operator-control-plane&lt;/code&gt; pod to generate the secrets, and once generated, restart the edge pod.
:::&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Identify Underperforming Services</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/identify-underperforming-services/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/identify-underperforming-services/</guid>
      <description>&lt;p&gt;Service performance degradations can be very difficult to understand and isolate:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;There is far too much data to dig through to identify the cause of the performance issue&lt;/li&gt;
&lt;li&gt;The experts in the application&amp;rsquo;s behavior (the dev team) typically do not have access to the running cluster&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Tetrate Service Bridge provides a set of tools to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Enable the TSB operator to retrieve an archive of service performance data from a running cluster&lt;/li&gt;
&lt;li&gt;Enable application developers to query this data to identify the slowest transactions (or those with errors) and determine the call graph associated with the slow response.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Before you get started, make sure you: &lt;br /&gt;
✓ Familiarize yourself with &lt;a href=&#34;../concepts/toc&#34;&gt;TSB concepts&lt;/a&gt; &lt;br /&gt;
✓ Install the &lt;a href=&#34;../setup/self_managed/demo-installation&#34;&gt;TSB demo&lt;/a&gt; environment &lt;br /&gt;
✓ Deploy the &lt;a href=&#34;../quickstart/deploy_sample_app&#34;&gt;Istio Bookinfo&lt;/a&gt; sample app &lt;br /&gt;&lt;/p&gt;
&lt;h2 id=&#34;collecting-data&#34;&gt;Collecting data&lt;/h2&gt;
&lt;p&gt;The TSB operator can use &lt;code&gt;tctl&lt;/code&gt; to collect the cluster state. This state includes proxy logs from the workloads, Istio controlplane information, node information, &lt;code&gt;istioctl analyze&lt;/code&gt; and other runtime information. Data is exported as a tar file.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Usage:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl collect &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;flags&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Examples:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Collect without any obfuscation or redaction&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl collect
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Collect without archiving results (useful for local debugging)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl collect --disable-archive
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Collect and redact with user-provided regex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl collect --redact-regexes &amp;lt;regex-one&amp;gt;,&amp;lt;regex-two&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Collect and redact with presets&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl collect --redact-presets networking
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Running &lt;code&gt;tctl collect&lt;/code&gt; requires admin permissions. The resulting tar file can be shared with application teams for analysis and interpretation, using &lt;code&gt;tctl troubleshoot&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;analysing-data&#34;&gt;Analysing Data&lt;/h2&gt;
&lt;p&gt;Any user can then run &lt;code&gt;tctl troubleshoot&lt;/code&gt; to inspect the collected tar file and generate a range of reports on the transactions recorded within the file:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Dump the cluster information to identify workloads&lt;/li&gt;
&lt;li&gt;Analyse requests to named workloads to identify slowest responses and error responses&lt;/li&gt;
&lt;li&gt;Discriminate between sidecar performance and application performance&lt;/li&gt;
&lt;li&gt;Obtain request IDs, and then generate full traces for these requests (call graph)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;analyzing-cluster-data&#34;&gt;Analyzing Cluster data&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Usage:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl experimental troubleshoot log-explorer cluster &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;flags&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Examples:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl experimental troubleshoot log-explorer cluster &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;tar file&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Flags:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  -h, --help               &lt;span class=&#34;nb&#34;&gt;help&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; cluster
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  -n, --namespace string   List details of only specified namespace
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      --workspace string   List details of only specified workspace
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;troubleshoot log-explorer cluster&lt;/code&gt; provides details of all workloads running in the cluster. Users can get a subset of the entire cluster state by applying filters like &lt;code&gt;--workspace&lt;/code&gt; or &lt;code&gt;--namespace&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$: tctl experimental troubleshoot log-explorer cluster tctl-debug-1664467971183386000.tar.gz --workspace organizations/tetrate/tenants/payment/workspaces/payment-ws
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;namespaces:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    payment-channel:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        services:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            details:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                - details-v1-7d88846999-wgmSV 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            productpage:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                - productpage-v1-7795568889-tghhb 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            ratings:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                - ratings-v1-754f9c4975-x9h86
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            tsb-gateway-bookinfo:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                - tsb-gateway-bookinfo-6c46758bf6-5q6vw 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    payment-offers:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        services:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            reviews:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                - reviews-primary-54c7dd49dc-8658t 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            reviews-canary:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods: &lt;span class=&#34;o&#34;&gt;[]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            reviews-primary:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                pods:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                - reviews-primary-54c7dd49dc-8658t
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;nodes:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- gke-cp-cluster-1-default-pool-1119254c-w7i
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- gke-cp-cluster-1-default-pool-a03a3024-7519
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- gke-cp-cluster-1-default-pool-a03a3024-btfs
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- gke-cp-cluster-1-default-pool-e090b6ac-trp
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;workspaces:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- organizations/tetrate/tenants/payment/workspaces/payment-ws
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;analyzing-service-data&#34;&gt;Analyzing Service data&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Usage:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl experimental troubleshoot log-explorer service &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;flags&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Examples:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl experimental log-explorer service &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;tar file&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;service&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Flags:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      --all                Show all requests instead of just the longest ones and those with errors.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      --full-log           Print the full Envoy access log instead of a summary.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  -h, --help               &lt;span class=&#34;nb&#34;&gt;help&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; service
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      --limit int          Number of requests to show &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;defaults to 10&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  -n, --namespace string   The namespace containing the service.
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;troubleshoot log-explorer service&lt;/code&gt; provides details about the 10 longest requests.  It outputs a summary of time elapsed within the envoy sidecar and within the application service.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../assets/tctl-service.png&#34;&gt;















&lt;figure  id=&#34;figure-tctl-troubleshoot-log-explorer-service&#34;&gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img src=&#34;../assets/tctl-service.png&#34; alt=&#34;tctl troubleshoot log-explorer service&#34; loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;figcaption&gt;
      tctl troubleshoot log-explorer service
    &lt;/figcaption&gt;&lt;/figure&gt;
&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;With this report, users can obtain the Request IDs of the longest time consuming requests, for analysis in the next step. The &lt;code&gt;--full-log&lt;/code&gt; flag can also be used to access the Envoy request log information.&lt;/p&gt;
&lt;h3 id=&#34;analyzing-request-data&#34;&gt;Analyzing Request data&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Usage:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl experimental troubleshoot log-explorer request &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;flags&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Examples:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  tctl experimental log-explorer request &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;tar file&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;requestID&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Flags:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  -h, --help                 &lt;span class=&#34;nb&#34;&gt;help&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; request
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  -o, --output-type string   Select the output type, available formats json and yaml, default format is yaml &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default &lt;span class=&#34;s2&#34;&gt;&amp;#34;yaml&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;troubleshoot log-explorer request&lt;/code&gt; reports the trace for a single request identified by the provided &lt;code&gt;requestID&lt;/code&gt;. It outputs the chain of requests, starting from the IngressGateway Pod IP to the final application workload. The report presents the total time spent by the Envoy sidecar, and the Application services along with details like &lt;code&gt;requestType&lt;/code&gt; to indicate whether a request is &lt;code&gt;inbound&lt;/code&gt; or &lt;code&gt;outbound&lt;/code&gt;, namespace and name of the workload and &lt;code&gt;calledBy&lt;/code&gt; IP &amp;amp; Port etc.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;../assets/tctl-request.png&#34;&gt;















&lt;figure  id=&#34;figure-tctl-troubleshoot-log-explorer-request&#34;&gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img src=&#34;../assets/tctl-request.png&#34; alt=&#34;tctl troubleshoot log-explorer request&#34; loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;figcaption&gt;
      tctl troubleshoot log-explorer request
    &lt;/figcaption&gt;&lt;/figure&gt;
&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Maximum Header Size Exceed</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/maximum-header-size-exceed/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/maximum-header-size-exceed/</guid>
      <description>&lt;p&gt;This article will cover how TSB and istio-proxy handle headers when forwarding from Istio ingress gateways or sidecars to applications.&lt;/p&gt;
&lt;p&gt;Before you get started, make sure you:&lt;br /&gt;
✓ Familiarize yourself with &lt;a href=&#34;../concepts/toc&#34;&gt;TSB concepts&lt;/a&gt; &lt;br /&gt;
✓ Install the TSB environment. You can use &lt;a href=&#34;../setup/self_managed/demo-installation&#34;&gt;TSB demo&lt;/a&gt; for quick install&lt;br /&gt;
✓ Completed &lt;a href=&#34;../quickstart&#34;&gt;TSB usage quickstart&lt;/a&gt;.&lt;br /&gt;
✓ Install sample application &lt;a href=&#34;../reference/samples/httpbin&#34;&gt;httpbin&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;request-header-size-in-envoy-istio-proxy&#34;&gt;Request header size in Envoy (istio-proxy)&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Envoy&lt;/a&gt; or istio-proxy can handle headers that are considerably larger. The default maximum request headers size for incoming connections is 60 KiB&lt;/p&gt;
&lt;p&gt;In this case, it will not be an issue for the majority of applications, and the request headers that incoming connections will be proxied through istio-proxy. However, your application might have restrictions based on the configuration of the header size for each web server.&lt;/p&gt;
&lt;p&gt;For example:
In &lt;a href=&#34;https://www.baeldung.com/spring-boot-max-http-header-size&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Spring Boot 2&lt;/a&gt; and &lt;a href=&#34;https://docs.gunicorn.org/en/stable/settings.html#limit-request-field-size&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Gunicorn&lt;/a&gt; the default max header size is 8 KiB. You can override the default if needed.&lt;/p&gt;
&lt;h2 id=&#34;debug-request-headers-size&#34;&gt;Debug request headers size&lt;/h2&gt;
&lt;p&gt;For this experiment, you will need the &lt;a href=&#34;../reference/samples/httpbin&#34;&gt;httpbin&lt;/a&gt; sample application deployed in your cluster. You will perform two requests, one with a header size below the maximum and another one that exceeds the limit by the app container.&lt;/p&gt;
&lt;h3 id=&#34;header-below-the-maximum&#34;&gt;Header below the maximum&lt;/h3&gt;
&lt;p&gt;Your header can be anything just make sure is below 8 KiB you can export it as a variable and perform the request:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;curl -k  https://httpbin.example.io/response-headers -X POST -H &amp;#34;X-MyHeader: $SMALL&amp;#34; -sI
HTTP/2 200 
server: istio-envoy
date: Wed, 19 Oct 2022 20:13:49 GMT
content-type: application/json
content-length: 68
access-control-allow-origin: *
access-control-allow-credentials: true
x-envoy-upstream-service-time: 5
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;header-above-the-maximum&#34;&gt;Header above the maximum&lt;/h3&gt;
&lt;p&gt;Now perform the request with a header that can exceed the maximum of 8 KiB&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;curl -k  https://httpbin.example.io/response-headers -X POST -H &amp;#34;X-MyHeader: $LONG&amp;#34; -sI
HTTP/2 400 
content-type: text/html
content-length: 189
x-envoy-upstream-service-time: 6
date: Wed, 19 Oct 2022 20:17:37 GMT
server: istio-envoy
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If the request header exceed the maximum header size, you will receive a bad request following a 400 HTTP code.&lt;/p&gt;
&lt;h2 id=&#34;modify-header-size-in-istio-proxy&#34;&gt;Modify header size in istio-proxy&lt;/h2&gt;
&lt;p&gt;As you learned above, you can limit the header size in a variety of web servers. You can do the same modifications in istio-proxy.&lt;/p&gt;
&lt;p&gt;The default header size should be just enough, or you may want to decrease the default size.&lt;/p&gt;
&lt;h3 id=&#34;decreasing-the-default-size-of-the-header-in-istio-proxy&#34;&gt;Decreasing the default size of the header in istio-proxy&lt;/h3&gt;
&lt;p&gt;In order to decrease the size of the default request header you will need to create an &lt;a href=&#34;https://istio.io/latest/docs/reference/config/networking/envoy-filter/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Envoyfilter&lt;/a&gt; that allows you to modify the istio-proxy configuration.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: max-request-headers
  namespace: istio-system
spec:
  configPatches:
  - applyTo: NETWORK_FILTER # http connection manager is a filter in Envoy
    match:
      context: ANY
      listener:
        filterChain:
          filter:
            name: &amp;#34;envoy.filters.network.http_connection_manager&amp;#34;
    patch:
      operation: MERGE
      value:
        typed_config:
          &amp;#34;@type&amp;#34;: &amp;#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&amp;#34;
          max_request_headers_kb: 10
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Once this is applied in your cluster, try again the request with an small header and a larger one.&lt;/p&gt;
&lt;h3 id=&#34;header-below-the-maximum-in-istio-proxy&#34;&gt;Header below the maximum in istio-proxy&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;curl -k  https://httpbin.example.io/response-headers -X POST -H &amp;#34;X-MyHeader: $SMALL&amp;#34; -sI
HTTP/2 200 
server: istio-envoy
date: Wed, 19 Oct 2022 20:36:43 GMT
content-type: application/json
content-length: 68
access-control-allow-origin: *
access-control-allow-credentials: true
x-envoy-upstream-service-time: 5
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You can see the request was successfully as the header was below the maximum of 10 KiB.&lt;/p&gt;
&lt;h3 id=&#34;header-above-the-maximum-in-istio-proxy&#34;&gt;Header above the maximum in istio-proxy&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;curl -k  https://httpbin.example.io/response-headers -X POST -H &amp;#34;X-MyHeader: $LONG&amp;#34; -sI
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You can remove the -s flag from curl and see the output.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;curl -k  https://httpbin.example.io/response-headers -X POST -H &amp;#34;X-MyHeader: $LONG&amp;#34; -I
curl: (92) HTTP/2 stream 0 was not closed cleanly: INTERNAL_ERROR (err 2)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The request did not return anything but an error. You can see what happened in the logs.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl logs $GWPOD -n tier1

[2022-10-19T20:39:58.081Z] &amp;#34;- - HTTP/2&amp;#34; 0 - http2.too_many_headers - &amp;#34;-&amp;#34; 0 0 0 - &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; - - 10.211.129.34:8443 10.240.0.38:63077 httpbin.example.io -
&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
    <item>
      <title>Multiple Transfer Encoding Chunked</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/multiple-transfer-encoding-chunked/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/multiple-transfer-encoding-chunked/</guid>
      <description>&lt;p&gt;This document describes how TSB will handle the request/response if the header has multiple &lt;code&gt;transfer-encoding:chunked&lt;/code&gt;  and also helps you in identifying whether the problem is from the source or the destination.&lt;/p&gt;
&lt;p&gt;What we recommend to resolve this issue is to make sure that there is only one &lt;code&gt;transfer-encoding:chunked&lt;/code&gt; in both the request and the response header, otherwise Envoy will reject the request.&lt;/p&gt;
&lt;p&gt;Before you get started, make sure you: &lt;br /&gt;
✓ Familiarize yourself with &lt;a href=&#34;../concepts/toc&#34;&gt;TSB concepts&lt;/a&gt; &lt;br /&gt;
✓ Install the &lt;a href=&#34;../setup/self_managed/demo-installation&#34;&gt;TSB demo&lt;/a&gt; environment &lt;br /&gt;
✓ Deploy the &lt;a href=&#34;../quickstart/deploy_sample_app&#34;&gt;Istio Bookinfo&lt;/a&gt; sample app &lt;br /&gt;&lt;/p&gt;
&lt;p&gt;Note: For the response section, the application we used here deliberately generates multiple &lt;code&gt;transfer-encoding:chunked&lt;/code&gt; headers and it’s used for only documentation purpose.&lt;/p&gt;
&lt;p&gt;We have often seen that the header of the request/response contains multiple &lt;code&gt;transfer-encoding:chunked&lt;/code&gt; and this is not a valid header as Envoy rejects such request. In the bookinfo application that we have installed we can take a deeper look at how envoy will reject with specific error code for a simple request.&lt;/p&gt;
&lt;h2 id=&#34;request-header-with-transfer-encoding-chunkedchunked&#34;&gt;Request header with &amp;ldquo;Transfer-Encoding: chunked,chunked&amp;rdquo;&lt;/h2&gt;
&lt;p&gt;For our bookinfo app we will create a simple request using curl to send a multiple &lt;code&gt;transfer-encoding:chunked&lt;/code&gt; and we will observe how the envoy gateway will respond.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ curl  -kv &amp;#34;http://bookinfo.tetrate.com/productpage&amp;#34; -H &amp;#34;Transfer-Encoding: chunked&amp;#34; -H &amp;#34;Transfer-Encoding: chunked&amp;#34; 
[ ... ]
&amp;gt; GET /productpage HTTP/1.1
&amp;gt; Host: bookinfo.tetrate.com
&amp;gt; User-Agent: curl/7.79.1
&amp;gt; Accept: */*
&amp;gt; Transfer-Encoding: chunked
&amp;gt; Transfer-Encoding: chunked
&amp;gt; 
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 501 Not Implemented
&amp;lt; content-length: 15
&amp;lt; content-type: text/plain
&amp;lt; date: Tue, 13 Sep 2022 11:08:56 GMT
&amp;lt; server: istio-envoy
&amp;lt; connection: close
&amp;lt; 
* Closing connection 0
Not Implemented%
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;At the same time the gateway envoy logs show the failure with the below snippet and the error code as &lt;code&gt;501 DPE (Downstream Protocol Error)&lt;/code&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl logs ${GWPOD} -n bookinfo 
[2022-09-07T08:17:38.936Z] &amp;#34;- - HTTP/1.1&amp;#34; 501 DPE http1.invalid_transfer_encoding - &amp;#34;-&amp;#34; 0 15 0 - &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; &amp;#34;-&amp;#34; - - 10.0.2.20:8080 10.128.0.74:23365 - -
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;response-header-with-transfer-encoding-chunkedchunked&#34;&gt;Response header with &amp;ldquo;Transfer-Encoding: chunked,chunked&amp;rdquo;&lt;/h2&gt;
&lt;p&gt;The response header can be manipulated within the application itself and could trigger the multiple chunks as well. In these cases the envoy sidecar of that application will reject the response.
To demonstrate the response we used a simple application which will generate multiple transfer-chunked as a default behavior,We will send a curl request from the &lt;a href=&#34;./debug-container&#34;&gt;Debug-container&lt;/a&gt; with default values as shown below.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$curl -v http://transfer:8080/test
[ ... ]
&amp;gt; GET /test HTTP/1.1
&amp;gt; Host: transfer:8080
&amp;gt; User-Agent: curl/7.83.1
&amp;gt; Accept: */*
&amp;gt; 
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 502 Bad Gateway
&amp;lt; content-length: 87
&amp;lt; content-type: text/plain
&amp;lt; date: Tue, 13 Sep 2022 11:17:13 GMT
&amp;lt; server: envoy
&amp;lt; x-envoy-upstream-service-time: 2
&amp;lt; 
* Connection #0 to host transfer left intact
upstream connect error or disconnect/reset before headers. reset reason: protocol error/ 
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When we look at the sidecar envoy log we can see the rejection with the error message &lt;code&gt;502 UPE (Upstream Protocol Error)&lt;/code&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl logs transfer-58c6c67c56-d8wzk  -n test 
[2022-09-13T11:17:13.471Z] &amp;#34;GET /test HTTP/1.1&amp;#34; 502 UPE upstream_reset_before_response_started{protocol_error} - &amp;#34;-&amp;#34; 0 87 1 - &amp;#34;-&amp;#34; &amp;#34;curl/7.83.1&amp;#34; &amp;#34;fbcd5bff-1981-40a5-a2c8-fd6133161976&amp;#34; &amp;#34;transfer:8080&amp;#34; &amp;#34;10.0.2.7:8080&amp;#34; inbound|8080|| 127.0.0.6:53799 10.0.2.7:8080 10.0.0.21:59960 outbound_.8080_._.transfer.test.svc.cluster.local default
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If we enable the debug log for sidecar of the application we can see the error in details as&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2022-09-13T12:46:48.497388Z     debug   envoy client    [C2912] Error dispatching received data: http/1.1 protocol error: unsupported transfer encoding
&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
    <item>
      <title>UI Metrics Troubleshooting</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/tsb-ui-metrics/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/tsb-ui-metrics/</guid>
      <description>&lt;p&gt;TSB&amp;rsquo;s UI displays metrics and health of your services. However, if there are no
metrics or traces displayed, then you may be facing an issue with either your
services, or with TSB.&lt;/p&gt;
&lt;p&gt;This guide will walk you through how to determine whether the issue is with a
service, or with one of the metrics components within TSB.&lt;/p&gt;
&lt;h2 id=&#34;metrics&#34;&gt;Metrics&lt;/h2&gt;
&lt;p&gt;If you don&amp;rsquo;t see the metrics, use this section of the guide to troubleshoot.&lt;/p&gt;
&lt;p&gt;First, make sure that you have traffic flowing in your application. You need
traffic to generate metrics.&lt;/p&gt;
&lt;p&gt;Check that the time range window you&amp;rsquo;ve set in TSB is correct, and there was
traffic during that period.&lt;/p&gt;
&lt;p&gt;















&lt;figure  &gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img src=&#34;../assets/023f435-Tetrate_Service_Bridge.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;Check if running a UI query in your browser returns a status. Use your browser
&lt;code&gt;inspect&lt;/code&gt; command and check the request/response details.&lt;/p&gt;
&lt;p&gt;From the inspector, select the &lt;code&gt;Network&lt;/code&gt; tab and open your application from the
TSB UI. You should see a list of all the requests between your browser and the
TSB backend.&lt;/p&gt;
&lt;p&gt;Search for the last &lt;code&gt;graphql&lt;/code&gt; request.&lt;/p&gt;
&lt;p&gt;















&lt;figure  &gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img src=&#34;../assets/71914d4-DevTools_-_35_247_59_43_8443_applications_prune-tenant_dev_bookinfo.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;















&lt;figure  &gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img src=&#34;../assets/47326cc-DevTools_-_35_247_59_43_8443_applications_prune-tenant_dev_bookinfo-2.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;If you don&amp;rsquo;t see the query, it may indicate that your application is not
handling any traffic, or you&amp;rsquo;re having a problem with the OAP deployment.&lt;/p&gt;
&lt;p&gt;To inspect OAP, use the following steps:&lt;/p&gt;
&lt;p&gt;Check if the &lt;code&gt;OAP&lt;/code&gt; Pod in the &lt;code&gt;tsb&lt;/code&gt; Namespace is up and running by confirming
whether there are any errors in the pod&amp;rsquo;s log:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n tsb logs -l &lt;span class=&#34;nv&#34;&gt;app&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;oap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The errors from the logs will help you triage the problem.&lt;/p&gt;
&lt;p&gt;If the issue is related to Elasticsearch, check if OAP in the control plane
namespace (istio-system) is receiving Access Log Service (ALS) data from various
Envoys by forwarding the monitoring port of the OAP pods to your local computer,
and querying some metrics using the following steps:&lt;/p&gt;
&lt;p&gt;Start a port-forward to OAP in a shell:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n istio-system port-forward deployment/oap-deployment &lt;span class=&#34;m&#34;&gt;1234&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If there is no issue, you should see:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-text&#34; data-lang=&#34;text&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Forwarding from 127.0.0.1:1234 -&amp;gt; 1234
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Forwarding from [::1]:1234 -&amp;gt; 1234
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In a different shell, curl the metrics with the command below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;curl -s http://localhost:1234/ &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; grep &lt;span class=&#34;s2&#34;&gt;&amp;#34;envoy_als_in_count&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You should see something similar to this example output:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-text&#34; data-lang=&#34;text&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;router~10.28.0.25~tsb-gateway-7b7fbcdfb7-726bf.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;tsb-gateway&amp;#34;,} 67492.0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;sidecar~10.28.0.19~details-v1-94d5d794-kt76x.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;details.bookinfo&amp;#34;,} 33747.0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;sidecar~10.28.0.23~reviews-v3-5556b6949-pvqfn.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;reviews.bookinfo&amp;#34;,} 22500.0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;sidecar~10.28.0.24~productpage-v1-665ddb5664-ts6pz.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;productpage.bookinfo&amp;#34;,} 101240.0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;sidecar~10.28.0.22~reviews-v2-6cb744f8ff-mf8s6.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;reviews.bookinfo&amp;#34;,} 22498.0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;sidecar~10.28.0.20~ratings-v1-744894fbdb-ctvpd.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;ratings.bookinfo&amp;#34;,} 22499.0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_als_in_count{id=&amp;#34;sidecar~10.28.0.21~reviews-v1-f7c7c7b45-8v2sf.bookinfo~bookinfo.svc.cluster.local&amp;#34;,cluster=&amp;#34;reviews.bookinfo&amp;#34;,} 11249.0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You should see the numbers on the right-hand side increase if your application
is in use.&lt;/p&gt;
&lt;p&gt;If you don&amp;rsquo;t see any metrics, or the metrics do not change over time, check if
your application sidecars (Envoy) are sending ALS metrics to the control plane
OAP by performing a&lt;code&gt;port-forward&lt;/code&gt; of the Istio Sidecar on port 15000 and query
the &lt;code&gt;envoy_accesslog_service&lt;/code&gt; metric. The standard number of  &lt;code&gt;cx_active&lt;/code&gt;
metrics (i.e. the number of current connections) is two.&lt;/p&gt;
&lt;p&gt;The below example uses the &lt;code&gt;productpage&lt;/code&gt; service of the &lt;code&gt;bookinfo&lt;/code&gt; application:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# start the port-forward in a shell&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n bookinfo port-forward deployment/productpage-v1 &lt;span class=&#34;m&#34;&gt;15000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Forwarding from 127.0.0.1:15000 -&amp;gt; &lt;span class=&#34;m&#34;&gt;15000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Forwarding from &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;::1&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;:15000 -&amp;gt; &lt;span class=&#34;m&#34;&gt;15000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# curl the config in another shell&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;curl -s http://localhost:15000/clusters &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; grep &lt;span class=&#34;s2&#34;&gt;&amp;#34;envoy_accesslog_service&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; grep cx_active
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;envoy_accesslog_service::10.31.243.206:11800::cx_active::2
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If the counters aren&amp;rsquo;t what you expect, add &lt;code&gt;debug&lt;/code&gt; logging level to OAP by
editing the OAP&amp;rsquo;s &lt;code&gt;config.yml&lt;/code&gt; with the following command:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n istio-system edit cm oap-config
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Search for the following lines and remove the comments around it:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&amp;lt;!-- uncomment following line when need to debug ALS raw data
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;   &amp;lt;logger name=&amp;#34;io.tetrate.spm.user.receiver.envoy&amp;#34; level=&amp;#34;DEBUG&amp;#34;/&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;--&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;So that it becomes:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;&amp;lt;logger&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;io.tetrate.spm.user.receiver.envoy&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;level=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;DEBUG&amp;#34;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, restart OAP for the configuration change to take effect:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n istio-system delete pod -l &lt;span class=&#34;nv&#34;&gt;app&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;oap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now you can search the logs for &lt;code&gt;downstream_remote_address&lt;/code&gt;. If you have
searchable logs, it  means that the metrics are reaching the OAP service.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;search in the Elasticsearch back-end&lt;br/&gt;
Metrics are kept in Elasticsearch (ES) indices. You can check the status and
health of the ES by sending some queries.&lt;br/&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As the ES server is not managed by TSB, please refer to your documentation for
the correct connection string.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;In the example, we set a port-forward to the ES pod inside the &lt;code&gt;tsb&lt;/code&gt; namespace.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# port forward to ES server&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n tsb port-forward statefulset/elasticsearch &lt;span class=&#34;m&#34;&gt;9200&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# check cluster health&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;curl -s  &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://localhost:9200/_cluster/health?pretty=true&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;cluster_name&amp;#34;&lt;/span&gt; : &lt;span class=&#34;s2&#34;&gt;&amp;#34;elasticsearch&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;status&amp;#34;&lt;/span&gt; : &lt;span class=&#34;s2&#34;&gt;&amp;#34;yellow&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;timed_out&amp;#34;&lt;/span&gt; : false,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;number_of_nodes&amp;#34;&lt;/span&gt; : 1,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;number_of_data_nodes&amp;#34;&lt;/span&gt; : 1,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;active_primary_shards&amp;#34;&lt;/span&gt; : 64,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;active_shards&amp;#34;&lt;/span&gt; : 64,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;relocating_shards&amp;#34;&lt;/span&gt; : 0,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;initializing_shards&amp;#34;&lt;/span&gt; : 0,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;unassigned_shards&amp;#34;&lt;/span&gt; : 5,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;delayed_unassigned_shards&amp;#34;&lt;/span&gt; : 0,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;number_of_pending_tasks&amp;#34;&lt;/span&gt; : 0,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;number_of_in_flight_fetch&amp;#34;&lt;/span&gt; : 0,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;task_max_waiting_in_queue_millis&amp;#34;&lt;/span&gt; : 0,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;s2&#34;&gt;&amp;#34;active_shards_percent_as_number&amp;#34;&lt;/span&gt; : 92.7536231884058
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;status&lt;/code&gt; line should be green or yellow. If it&amp;rsquo;s red, then the issue is
with the ES cluster. You should check the indices&amp;rsquo; status using the command:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Indices status for the 26 March 2020&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;curl -H&lt;span class=&#34;s1&#34;&gt;&amp;#39;Content-Type: application/json&amp;#39;&lt;/span&gt; -s -XGET &lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;http://localhost:9200/_cat/shards/*20200326
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You should see a list of all the indices. They should all be in the &lt;code&gt;STARTED&lt;/code&gt;
state. Next columns hold the number of documents and the size of the index. By
running the command at different times, you should see these numbers increasing.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;service_5xx-20200326                                 0 p STARTED  31236   1.4mb 10.28.1.12 elasticsearch-0
service_instance_relation_client_call_sla-20200326   0 p STARTED  53791   5.1mb 10.28.1.12 elasticsearch-0
endpoint_percentile-20200326                         0 p STARTED 128707  12.7mb 10.28.1.12 elasticsearch-0
endpoint_2xx-20200326                                0 p STARTED 123131   7.4mb 10.28.1.12 elasticsearch-0
...
&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
    <item>
      <title>Using The Debug Container</title>
      <link>https://lib.jimmysong.io/tsb/troubleshooting/debug-container/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/troubleshooting/debug-container/</guid>
      <description>&lt;p&gt;import vars from &amp;ldquo;../_vars.json&amp;rdquo;;&lt;/p&gt;
&lt;p&gt;Tetrate Service Bridge (TSB) is a complex collection of components that are interconnected using various protocols. This is probably also true for your applications deployed over the service mesh that TSB provides. In many cases you will need to check, test, and verify the network connectivity within the various TSB components to make sure that the system is working as expected.&lt;/p&gt;
&lt;p&gt;To save you some time to create a debugging environment in the Kubernetes clusters, Tetrate provides a debug container that comes with most of the toolsets needed to validate the network status already installed. For example, tools such as &lt;code&gt;ping&lt;/code&gt;, &lt;code&gt;curl&lt;/code&gt;, &lt;code&gt;gpcurl&lt;/code&gt;, &lt;code&gt;dig&lt;/code&gt;, etc are already installed in this container.&lt;/p&gt;
&lt;h2 id=&#34;using-the-debug-container&#34;&gt;Using the debug container&lt;/h2&gt;
&lt;p&gt;This debug container can be deployed to any cluster as long as the appropriate image registry can be reached to download the container image.&lt;/p&gt;
&lt;p&gt;The container image is included in the TSB distribution and will be synced to your registry along with the rest of the images when you run the &lt;a href=&#34;../setup/requirements-and-download#sync-tetrate-service-bridge-images&#34;&gt;&lt;code&gt;tctl install image-sync&lt;/code&gt; command&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To deploy the debug container, run the following command. Replace &lt;code&gt;&amp;lt;registry-location&amp;gt;&lt;/code&gt; with the registry URL where you synced the TSB images.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;
{`kubectl run debug-container --image &lt;registry-location&gt;/tetrate-troubleshoot:${vars.versionNumber} -it -- ash`}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once the pod is created, you will be placed in a shell within the debug container and you will be able to run necessary commands for troubleshooting.&lt;/p&gt;
&lt;h3 id=&#34;checking-the-network-connectivity&#34;&gt;Checking the network connectivity&lt;/h3&gt;
&lt;p&gt;If you want to check the network connectivity from the TSB cluster to the datastore you use (we assume PostgreSQL for this example), you can run the following command:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;curl -v telnet://&amp;lt;postgres_IP&amp;gt;:5432
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Or use the PostgreSQL client command &lt;code&gt;psql&lt;/code&gt; to validate the credentials.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;psql -h my.postgres.local -P &lt;span class=&#34;m&#34;&gt;5432&lt;/span&gt; -U myUser
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
  </channel>
</rss>
